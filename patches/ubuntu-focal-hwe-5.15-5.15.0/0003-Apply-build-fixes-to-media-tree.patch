From 532fb8eb02f544bc8b04d0b94fbec03f37b86e9f Mon Sep 17 00:00:00 2001
From: Brad Love <hidden@email.co>
Date: Thu, 9 Mar 2023 10:33:42 -0600
Subject: [PATCH 3/6] Apply build fixes to media tree

---
 drivers/media/cec/core/cec-api.c                              | 2 ++
 drivers/media/common/videobuf2/frame_vector.c                 | 2 ++
 drivers/media/common/videobuf2/videobuf2-memops.c             | 2 ++
 drivers/media/dvb-core/dvb_net.c                              | 2 ++
 drivers/media/i2c/hi556.c                                     | 4 ++--
 drivers/media/i2c/imx319.c                                    | 4 ++--
 drivers/media/mc/mc-device.c                                  | 2 ++
 drivers/media/rc/Makefile                                     | 2 +-
 drivers/media/usb/em28xx/em28xx-dvb.c                         | 2 +-
 drivers/media/v4l2-core/v4l2-ioctl.c                          | 2 ++
 .../media/atomisp/pci/hive_isp_css_common/host/input_system.c | 1 +
 include/media/videobuf2-core.h                                | 1 -
 include/media/videobuf2-v4l2.h                                | 2 ++
 13 files changed, 21 insertions(+), 7 deletions(-)

diff --git a/drivers/media/cec/core/cec-api.c b/drivers/media/cec/core/cec-api.c
index 1c3096820..f7955a829 100644
--- a/drivers/media/cec/core/cec-api.c
+++ b/drivers/media/cec/core/cec-api.c
@@ -22,6 +22,8 @@
 #include "cec-priv.h"
 #include "cec-pin-priv.h"
 
+#include <media/compat.h>
+
 static inline struct cec_devnode *cec_devnode_data(struct file *filp)
 {
 	struct cec_fh *fh = filp->private_data;
diff --git a/drivers/media/common/videobuf2/frame_vector.c b/drivers/media/common/videobuf2/frame_vector.c
index 542dde9d2..a10c7d6cf 100644
--- a/drivers/media/common/videobuf2/frame_vector.c
+++ b/drivers/media/common/videobuf2/frame_vector.c
@@ -10,6 +10,8 @@
 
 #include <media/frame_vector.h>
 
+#include <media/compat.h>
+
 /**
  * get_vaddr_frames() - map virtual addresses to pfns
  * @start:	starting user address
diff --git a/drivers/media/common/videobuf2/videobuf2-memops.c b/drivers/media/common/videobuf2/videobuf2-memops.c
index 9dd6c2716..c8da1c859 100644
--- a/drivers/media/common/videobuf2/videobuf2-memops.c
+++ b/drivers/media/common/videobuf2/videobuf2-memops.c
@@ -40,6 +40,7 @@ struct frame_vector *vb2_create_framevec(unsigned long start,
 	unsigned long first, last;
 	unsigned long nr;
 	struct frame_vector *vec;
+//	unsigned int flags = FOLL_FORCE;
 
 	first = start >> PAGE_SHIFT;
 	last = (start + length - 1) >> PAGE_SHIFT;
@@ -47,6 +48,7 @@ struct frame_vector *vb2_create_framevec(unsigned long start,
 	vec = frame_vector_create(nr);
 	if (!vec)
 		return ERR_PTR(-ENOMEM);
+//	ret = get_vaddr_frames(start & PAGE_MASK, nr, flags, vec);
 	ret = get_vaddr_frames(start & PAGE_MASK, nr, vec);
 	if (ret < 0)
 		goto out_destroy;
diff --git a/drivers/media/dvb-core/dvb_net.c b/drivers/media/dvb-core/dvb_net.c
index 82a09f560..5f704d3d7 100644
--- a/drivers/media/dvb-core/dvb_net.c
+++ b/drivers/media/dvb-core/dvb_net.c
@@ -58,6 +58,8 @@
 #include <media/dvb_demux.h>
 #include <media/dvb_net.h>
 
+#include <media/compat.h>
+
 static inline __u32 iov_crc32( __u32 c, struct kvec *iov, unsigned int cnt )
 {
 	unsigned int j;
diff --git a/drivers/media/i2c/hi556.c b/drivers/media/i2c/hi556.c
index 055d1aa84..a455860f3 100644
--- a/drivers/media/i2c/hi556.c
+++ b/drivers/media/i2c/hi556.c
@@ -1134,7 +1134,7 @@ static int hi556_probe(struct i2c_client *client)
 
 	v4l2_i2c_subdev_init(&hi556->sd, client, &hi556_subdev_ops);
 
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		ret = hi556_identify_module(hi556);
 		if (ret) {
@@ -1208,7 +1208,7 @@ static struct i2c_driver hi556_i2c_driver = {
 	},
 	.probe_new = hi556_probe,
 	.remove = hi556_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 
 module_i2c_driver(hi556_i2c_driver);
diff --git a/drivers/media/i2c/imx319.c b/drivers/media/i2c/imx319.c
index a2b5a34de..dfdb7c441 100644
--- a/drivers/media/i2c/imx319.c
+++ b/drivers/media/i2c/imx319.c
@@ -2444,7 +2444,7 @@ static int imx319_probe(struct i2c_client *client)
 	/* Initialize subdev */
 	v4l2_i2c_subdev_init(&imx319->sd, client, &imx319_subdev_ops);
 
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		/* Check module identity */
 		ret = imx319_identify_module(imx319);
@@ -2558,7 +2558,7 @@ static struct i2c_driver imx319_i2c_driver = {
 	},
 	.probe_new = imx319_probe,
 	.remove = imx319_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 module_i2c_driver(imx319_i2c_driver);
 
diff --git a/drivers/media/mc/mc-device.c b/drivers/media/mc/mc-device.c
index f361319f9..9793ce83d 100644
--- a/drivers/media/mc/mc-device.c
+++ b/drivers/media/mc/mc-device.c
@@ -24,6 +24,8 @@
 #include <media/media-entity.h>
 #include <media/media-request.h>
 
+#include <media/compat.h>
+
 #ifdef CONFIG_MEDIA_CONTROLLER
 
 /*
diff --git a/drivers/media/rc/Makefile b/drivers/media/rc/Makefile
index 3d0911783..a9285266e 100644
--- a/drivers/media/rc/Makefile
+++ b/drivers/media/rc/Makefile
@@ -4,7 +4,7 @@ obj-y += keymaps/
 
 rc-core-y := rc-main.o rc-ir-raw.o
 rc-core-$(CONFIG_LIRC) += lirc_dev.o
-rc-core-$(CONFIG_MEDIA_CEC_RC) += rc-cec.o
+rc-core-$(CONFIG_MEDIA_CEC_RC) += keymaps/rc-cec.o
 rc-core-$(CONFIG_BPF_LIRC_MODE2) += bpf-lirc.o
 
 obj-$(CONFIG_RC_CORE) += rc-core.o
diff --git a/drivers/media/usb/em28xx/em28xx-dvb.c b/drivers/media/usb/em28xx/em28xx-dvb.c
index 9530c41c4..fed16bcb2 100644
--- a/drivers/media/usb/em28xx/em28xx-dvb.c
+++ b/drivers/media/usb/em28xx/em28xx-dvb.c
@@ -44,7 +44,7 @@
 #include "mt352.h"
 #include "mt352_priv.h" /* FIXME */
 #include "tda1002x.h"
-#include "drx39xxj.h"
+#include "../../dvb-frontends/drx39xyj/drx39xxj.h"
 #include "tda18271.h"
 #include "s921.h"
 #include "drxd.h"
diff --git a/drivers/media/v4l2-core/v4l2-ioctl.c b/drivers/media/v4l2-core/v4l2-ioctl.c
index 9c017806b..3ef92783f 100644
--- a/drivers/media/v4l2-core/v4l2-ioctl.c
+++ b/drivers/media/v4l2-core/v4l2-ioctl.c
@@ -31,6 +31,8 @@
 
 #include <trace/events/v4l2.h>
 
+#include <media/compat.h>
+
 /* Zero out the end of the struct pointed to by p.  Everything after, but
  * not including, the specified field is cleared. */
 #define CLEAR_AFTER_FIELD(p, field) \
diff --git a/drivers/staging/media/atomisp/pci/hive_isp_css_common/host/input_system.c b/drivers/staging/media/atomisp/pci/hive_isp_css_common/host/input_system.c
index 712e01c37..f4ec7af77 100644
--- a/drivers/staging/media/atomisp/pci/hive_isp_css_common/host/input_system.c
+++ b/drivers/staging/media/atomisp/pci/hive_isp_css_common/host/input_system.c
@@ -1187,6 +1187,7 @@ static void input_system_network_configure(
 				    sub_id,
 				    &cfg->ctrl_unit_cfg[sub_id - CTRL_UNIT0_ID]);
 	}
+	return status;
 }
 
 static input_system_err_t configuration_to_registers(void)
diff --git a/include/media/videobuf2-core.h b/include/media/videobuf2-core.h
index 5468b633b..72a50850f 100644
--- a/include/media/videobuf2-core.h
+++ b/include/media/videobuf2-core.h
@@ -18,7 +18,6 @@
 #include <linux/dma-buf.h>
 #include <linux/bitops.h>
 #include <media/media-request.h>
-#include <media/frame_vector.h>
 
 #define VB2_MAX_FRAME	(32)
 #define VB2_MAX_PLANES	(8)
diff --git a/include/media/videobuf2-v4l2.h b/include/media/videobuf2-v4l2.h
index d818d9707..8b956177b 100644
--- a/include/media/videobuf2-v4l2.h
+++ b/include/media/videobuf2-v4l2.h
@@ -15,6 +15,8 @@
 #include <linux/videodev2.h>
 #include <media/videobuf2-core.h>
 
+#include <media/frame_vector.h>
+
 #if VB2_MAX_FRAME != VIDEO_MAX_FRAME
 #error VB2_MAX_FRAME != VIDEO_MAX_FRAME
 #endif
-- 
2.25.1

