From f51414497eb05c30297b8141777fe5b5354dbf73 Mon Sep 17 00:00:00 2001
From: Bradford Love <hidden@email.co>
Date: Wed, 17 Apr 2024 16:26:40 -0500
Subject: [PATCH 3/6] Apply build fixes to media tree

---
 drivers/media/cec/core/cec-api.c           |  3 +++
 drivers/media/i2c/hi556.c                  |  4 +--
 drivers/media/i2c/imx208.c                 |  4 +--
 drivers/media/i2c/imx319.c                 |  4 +--
 drivers/media/i2c/ov2740.c                 |  4 +--
 drivers/media/i2c/ov5670.c                 |  4 +--
 drivers/media/i2c/ov5675.c                 |  4 +--
 drivers/media/i2c/ov8856.c                 |  4 +--
 drivers/media/mc/mc-device.c               |  2 ++
 drivers/media/pci/intel/ipu3/cio2-bridge.c |  6 +++--
 drivers/media/rc/Makefile                  |  2 +-
 drivers/media/usb/em28xx/em28xx-dvb.c      |  2 +-
 drivers/media/v4l2-core/v4l2-ioctl.c       |  2 ++
 include/linux/kernel_version.h             |  1 +
 include/media/config-compat.h              | 29 ++++++++++++++++++++++
 15 files changed, 57 insertions(+), 18 deletions(-)
 create mode 100644 include/linux/kernel_version.h
 create mode 100644 include/media/config-compat.h

diff --git a/drivers/media/cec/core/cec-api.c b/drivers/media/cec/core/cec-api.c
index 1c3096820590..3f321386b3db 100644
--- a/drivers/media/cec/core/cec-api.c
+++ b/drivers/media/cec/core/cec-api.c
@@ -19,6 +19,9 @@
 #include <linux/version.h>
 
 #include <media/cec-pin.h>
+
+#include <media/compat.h>
+
 #include "cec-priv.h"
 #include "cec-pin-priv.h"
 
diff --git a/drivers/media/i2c/hi556.c b/drivers/media/i2c/hi556.c
index 055d1aa8410e..a455860f3e87 100644
--- a/drivers/media/i2c/hi556.c
+++ b/drivers/media/i2c/hi556.c
@@ -1134,7 +1134,7 @@ static int hi556_probe(struct i2c_client *client)
 
 	v4l2_i2c_subdev_init(&hi556->sd, client, &hi556_subdev_ops);
 
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		ret = hi556_identify_module(hi556);
 		if (ret) {
@@ -1208,7 +1208,7 @@ static struct i2c_driver hi556_i2c_driver = {
 	},
 	.probe_new = hi556_probe,
 	.remove = hi556_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 
 module_i2c_driver(hi556_i2c_driver);
diff --git a/drivers/media/i2c/imx208.c b/drivers/media/i2c/imx208.c
index b9516b2f1c15..ec43f095d593 100644
--- a/drivers/media/i2c/imx208.c
+++ b/drivers/media/i2c/imx208.c
@@ -996,7 +996,7 @@ static int imx208_probe(struct i2c_client *client)
 	/* Initialize subdev */
 	v4l2_i2c_subdev_init(&imx208->sd, client, &imx208_subdev_ops);
 
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		/* Check module identity */
 		ret = imx208_identify_module(imx208);
@@ -1100,7 +1100,7 @@ static struct i2c_driver imx208_i2c_driver = {
 	},
 	.probe_new = imx208_probe,
 	.remove = imx208_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 
 module_i2c_driver(imx208_i2c_driver);
diff --git a/drivers/media/i2c/imx319.c b/drivers/media/i2c/imx319.c
index a2b5a34de76b..dfdb7c441d42 100644
--- a/drivers/media/i2c/imx319.c
+++ b/drivers/media/i2c/imx319.c
@@ -2444,7 +2444,7 @@ static int imx319_probe(struct i2c_client *client)
 	/* Initialize subdev */
 	v4l2_i2c_subdev_init(&imx319->sd, client, &imx319_subdev_ops);
 
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		/* Check module identity */
 		ret = imx319_identify_module(imx319);
@@ -2558,7 +2558,7 @@ static struct i2c_driver imx319_i2c_driver = {
 	},
 	.probe_new = imx319_probe,
 	.remove = imx319_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 module_i2c_driver(imx319_i2c_driver);
 
diff --git a/drivers/media/i2c/ov2740.c b/drivers/media/i2c/ov2740.c
index d5f0eabf20c6..a50d1a2d37a3 100644
--- a/drivers/media/i2c/ov2740.c
+++ b/drivers/media/i2c/ov2740.c
@@ -1163,7 +1163,7 @@ static int ov2740_probe(struct i2c_client *client)
 		return -ENOMEM;
 
 	v4l2_i2c_subdev_init(&ov2740->sd, client, &ov2740_subdev_ops);
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		ret = ov2740_identify_module(ov2740);
 		if (ret) {
@@ -1239,7 +1239,7 @@ static struct i2c_driver ov2740_i2c_driver = {
 	},
 	.probe_new = ov2740_probe,
 	.remove = ov2740_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 
 module_i2c_driver(ov2740_i2c_driver);
diff --git a/drivers/media/i2c/ov5670.c b/drivers/media/i2c/ov5670.c
index 02f75c18e480..460443a915ca 100644
--- a/drivers/media/i2c/ov5670.c
+++ b/drivers/media/i2c/ov5670.c
@@ -2490,7 +2490,7 @@ static int ov5670_probe(struct i2c_client *client)
 	/* Initialize subdev */
 	v4l2_i2c_subdev_init(&ov5670->sd, client, &ov5670_subdev_ops);
 
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		/* Check module identity */
 		ret = ov5670_identify_module(ov5670);
@@ -2593,7 +2593,7 @@ static struct i2c_driver ov5670_i2c_driver = {
 	},
 	.probe_new = ov5670_probe,
 	.remove = ov5670_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 
 module_i2c_driver(ov5670_i2c_driver);
diff --git a/drivers/media/i2c/ov5675.c b/drivers/media/i2c/ov5675.c
index 82ba9f56baec..502589dad3ca 100644
--- a/drivers/media/i2c/ov5675.c
+++ b/drivers/media/i2c/ov5675.c
@@ -1208,7 +1208,7 @@ static int ov5675_probe(struct i2c_client *client)
 
 	v4l2_i2c_subdev_init(&ov5675->sd, client, &ov5675_subdev_ops);
 
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		ret = ov5675_identify_module(ov5675);
 		if (ret) {
@@ -1287,7 +1287,7 @@ static struct i2c_driver ov5675_i2c_driver = {
 	},
 	.probe_new = ov5675_probe,
 	.remove = ov5675_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 
 module_i2c_driver(ov5675_i2c_driver);
diff --git a/drivers/media/i2c/ov8856.c b/drivers/media/i2c/ov8856.c
index a9728afc81d4..a0e5a6771a48 100644
--- a/drivers/media/i2c/ov8856.c
+++ b/drivers/media/i2c/ov8856.c
@@ -2475,7 +2475,7 @@ static int ov8856_probe(struct i2c_client *client)
 
 	v4l2_i2c_subdev_init(&ov8856->sd, client, &ov8856_subdev_ops);
 
-	full_power = acpi_dev_state_d0(&client->dev);
+	full_power = true; //acpi_dev_state_d0(&client->dev);
 	if (full_power) {
 		ret = __ov8856_power_on(ov8856);
 		if (ret) {
@@ -2566,7 +2566,7 @@ static struct i2c_driver ov8856_i2c_driver = {
 	},
 	.probe_new = ov8856_probe,
 	.remove = ov8856_remove,
-	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
+//	.flags = I2C_DRV_ACPI_WAIVE_D0_PROBE,
 };
 
 module_i2c_driver(ov8856_i2c_driver);
diff --git a/drivers/media/mc/mc-device.c b/drivers/media/mc/mc-device.c
index f361319f9c25..9793ce83d140 100644
--- a/drivers/media/mc/mc-device.c
+++ b/drivers/media/mc/mc-device.c
@@ -24,6 +24,8 @@
 #include <media/media-entity.h>
 #include <media/media-request.h>
 
+#include <media/compat.h>
+
 #ifdef CONFIG_MEDIA_CONTROLLER
 
 /*
diff --git a/drivers/media/pci/intel/ipu3/cio2-bridge.c b/drivers/media/pci/intel/ipu3/cio2-bridge.c
index df6c94da2f6a..7dc8351d16fd 100644
--- a/drivers/media/pci/intel/ipu3/cio2-bridge.c
+++ b/drivers/media/pci/intel/ipu3/cio2-bridge.c
@@ -8,6 +8,8 @@
 #include <linux/property.h>
 #include <media/v4l2-fwnode.h>
 
+#include <media/compat.h>
+
 #include "cio2-bridge.h"
 
 /*
@@ -236,7 +238,7 @@ static void cio2_bridge_instantiate_vcm_i2c_client(struct cio2_sensor *sensor)
 	board_info.swnode = &sensor->swnodes[SWNODE_VCM];
 
 	sensor->vcm_i2c_client =
-		i2c_acpi_new_device_by_fwnode(acpi_fwnode_handle(sensor->adev),
+		i2c_acpi_new_device(get_dev_from_fwnode(acpi_fwnode_handle(sensor->adev)),
 					      1, &board_info);
 	if (IS_ERR(sensor->vcm_i2c_client)) {
 		dev_warn(&sensor->adev->dev, "Error instantiation VCM i2c-client: %ld\n",
@@ -391,7 +393,7 @@ static int cio2_bridge_sensors_are_ready(void)
 			if (!adev->status.enabled)
 				continue;
 
-			if (!acpi_dev_ready_for_enumeration(adev))
+			if (!(adev->status.present || adev->status.functional))
 				ready = false;
 		}
 	}
diff --git a/drivers/media/rc/Makefile b/drivers/media/rc/Makefile
index 3d09117835d5..a9285266e944 100644
--- a/drivers/media/rc/Makefile
+++ b/drivers/media/rc/Makefile
@@ -4,7 +4,7 @@ obj-y += keymaps/
 
 rc-core-y := rc-main.o rc-ir-raw.o
 rc-core-$(CONFIG_LIRC) += lirc_dev.o
-rc-core-$(CONFIG_MEDIA_CEC_RC) += rc-cec.o
+rc-core-$(CONFIG_MEDIA_CEC_RC) += keymaps/rc-cec.o
 rc-core-$(CONFIG_BPF_LIRC_MODE2) += bpf-lirc.o
 
 obj-$(CONFIG_RC_CORE) += rc-core.o
diff --git a/drivers/media/usb/em28xx/em28xx-dvb.c b/drivers/media/usb/em28xx/em28xx-dvb.c
index 9530c41c437d..fed16bcb24dc 100644
--- a/drivers/media/usb/em28xx/em28xx-dvb.c
+++ b/drivers/media/usb/em28xx/em28xx-dvb.c
@@ -44,7 +44,7 @@
 #include "mt352.h"
 #include "mt352_priv.h" /* FIXME */
 #include "tda1002x.h"
-#include "drx39xxj.h"
+#include "../../dvb-frontends/drx39xyj/drx39xxj.h"
 #include "tda18271.h"
 #include "s921.h"
 #include "drxd.h"
diff --git a/drivers/media/v4l2-core/v4l2-ioctl.c b/drivers/media/v4l2-core/v4l2-ioctl.c
index 9c017806b841..3ef92783faa8 100644
--- a/drivers/media/v4l2-core/v4l2-ioctl.c
+++ b/drivers/media/v4l2-core/v4l2-ioctl.c
@@ -31,6 +31,8 @@
 
 #include <trace/events/v4l2.h>
 
+#include <media/compat.h>
+
 /* Zero out the end of the struct pointed to by p.  Everything after, but
  * not including, the specified field is cleared. */
 #define CLEAR_AFTER_FIELD(p, field) \
diff --git a/include/linux/kernel_version.h b/include/linux/kernel_version.h
new file mode 100644
index 000000000000..85bd4b9831df
--- /dev/null
+++ b/include/linux/kernel_version.h
@@ -0,0 +1 @@
+#define V4L2_VERSION 332288
diff --git a/include/media/config-compat.h b/include/media/config-compat.h
new file mode 100644
index 000000000000..ba5db9d832bc
--- /dev/null
+++ b/include/media/config-compat.h
@@ -0,0 +1,29 @@
+#ifndef __CONFIG_COMPAT_H__
+#define __CONFIG_COMPAT_H__
+
+#include <linux/version.h>
+
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,33)
+#include <generated/autoconf.h>
+#else
+#include <linux/autoconf.h>
+#endif
+
+#include <linux/mmdebug.h>
+
+
+#define NEED_MIN3 1
+
+#define NEED_SETUP_TIMER 1
+
+#define NEED_GET_USER_PAGES_LONGTERM 1
+
+#define NEED_U8_MAX 1
+
+#define NEED_STRUCT_SIZE 1
+
+#define NEED_I2C_NEW_SECONDARY_DEV 1
+
+#define NEED_KEY_SCREENSAVER 1
+
+#endif
-- 
2.25.1

