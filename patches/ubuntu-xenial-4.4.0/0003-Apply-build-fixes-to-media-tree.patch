From da6c60758001609122ccaf9fe96b67bd41020f22 Mon Sep 17 00:00:00 2001
From: Brad Love <hidden@email.co>
Date: Tue, 30 Apr 2024 11:22:43 -0500
Subject: [PATCH 3/6] Apply build fixes to media tree

---
 drivers/media/cec/core/cec-adap.c                  |   2 +
 drivers/media/cec/core/cec-api.c                   |   3 +
 drivers/media/cec/core/cec-core.c                  |   2 +
 drivers/media/cec/usb/pulse8/pulse8-cec.c          |   2 +
 drivers/media/cec/usb/rainshadow/rainshadow-cec.c  |   2 +
 drivers/media/common/b2c2/Makefile                 |   4 +-
 drivers/media/common/saa7146/saa7146_fops.c        |   2 +
 drivers/media/common/saa7146/saa7146_vbi.c         |   3 +
 drivers/media/common/saa7146/saa7146_video.c       |   2 +
 drivers/media/common/v4l2-tpg/v4l2-tpg-core.c      |   2 +
 drivers/media/common/videobuf2/frame_vector.c      |   6 +-
 drivers/media/common/videobuf2/videobuf2-dma-sg.c  |   2 +
 drivers/media/common/videobuf2/videobuf2-memops.c  |   5 +-
 drivers/media/dvb-core/dmxdev.c                    |   2 +
 drivers/media/dvb-core/dvb_demux.c                 |   2 +
 drivers/media/dvb-core/dvb_net.c                   |   2 +
 drivers/media/dvb-frontends/mn88443x.c             |   4 +-
 drivers/media/i2c/Kconfig                          |   6 +-
 drivers/media/i2c/adv7604.c                        |   2 +-
 drivers/media/i2c/adv7842.c                        |   2 +-
 drivers/media/i2c/ak7375.c                         |   2 +
 drivers/media/i2c/ir-kbd-i2c.c                     |   2 +
 drivers/media/i2c/ov7740.c                         |   2 +
 drivers/media/i2c/smiapp/smiapp.h                  |   2 +-
 drivers/media/i2c/tc358743.c                       |   2 +-
 drivers/media/i2c/tda1997x.c                       |   6 +-
 drivers/media/i2c/tvaudio.c                        |   2 +
 drivers/media/i2c/tvp5150.c                        |   7 ++
 drivers/media/media-device.c                       |   2 +
 drivers/media/mmc/siano/Makefile                   |   2 +-
 drivers/media/pci/b2c2/Makefile                    |   2 +-
 drivers/media/pci/bt8xx/Makefile                   |   4 +-
 drivers/media/pci/bt8xx/bttv-driver.c              |   2 +
 drivers/media/pci/bt8xx/bttv-input.c               |   1 +
 drivers/media/pci/cx18/Makefile                    |   4 +-
 drivers/media/pci/cx18/cx18-fileops.c              |   2 +
 drivers/media/pci/cx18/cx18-streams.c              |   2 +
 drivers/media/pci/cx23885/Makefile                 |   4 +-
 drivers/media/pci/cx88/Makefile                    |   4 +-
 drivers/media/pci/ddbridge/Makefile                |   4 +-
 drivers/media/pci/ddbridge/ddbridge-core.c         |   2 +
 drivers/media/pci/dm1105/Makefile                  |   2 +-
 drivers/media/pci/ivtv/ivtv-driver.c               |   2 +
 drivers/media/pci/ivtv/ivtv-irq.c                  |   2 +
 drivers/media/pci/mantis/Makefile                  |   2 +-
 drivers/media/pci/netup_unidvb/Makefile            |   2 +-
 drivers/media/pci/netup_unidvb/netup_unidvb_core.c |   2 +
 drivers/media/pci/ngene/Makefile                   |   4 +-
 drivers/media/pci/pluto2/Makefile                  |   2 +-
 drivers/media/pci/pt1/Makefile                     |   4 +-
 drivers/media/pci/pt3/Makefile                     |   4 +-
 drivers/media/pci/saa7134/saa7134-core.c           |   2 +
 drivers/media/pci/saa7134/saa7134-input.c          |   2 +
 drivers/media/pci/saa7134/saa7134-ts.c             |   2 +
 drivers/media/pci/saa7134/saa7134-vbi.c            |   2 +
 drivers/media/pci/saa7134/saa7134-video.c          |   2 +
 drivers/media/pci/smipcie/Makefile                 |   4 +-
 drivers/media/pci/solo6x10/solo6x10-gpio.c         |   9 +-
 drivers/media/pci/ttpci/Makefile                   |   6 +-
 drivers/media/pci/ttpci/av7110_ipack.c             |   1 +
 drivers/media/pci/ttpci/av7110_ir.c                |   2 +
 drivers/media/pci/tw686x/tw686x-core.c             |   2 +
 drivers/media/platform/Kconfig                     |   1 +
 drivers/media/platform/vim2m.c                     |   2 +
 drivers/media/platform/vivid/vivid-rds-gen.c       |   2 +
 drivers/media/platform/vivid/vivid-vbi-gen.c       |   2 +
 drivers/media/platform/xilinx/Kconfig              |   4 +
 drivers/media/radio/wl128x/fmdrv_common.c          |   4 +-
 drivers/media/rc/Makefile                          |   2 +-
 drivers/media/rc/ene_ir.c                          |   2 +
 drivers/media/rc/gpio-ir-recv.c                    |   2 +
 drivers/media/rc/igorplugusb.c                     |   2 +
 drivers/media/rc/iguanair.c                        |   2 +
 drivers/media/rc/imon.c                            |   4 +
 drivers/media/rc/ir-mce_kbd-decoder.c              |   2 +
 drivers/media/rc/ir-rc6-decoder.c                  |   2 +
 drivers/media/rc/ir-sony-decoder.c                 |   2 +
 drivers/media/rc/keymaps/rc-cec.c                  |   2 +
 drivers/media/rc/keymaps/rc-ct-90405.c             |   2 +
 drivers/media/rc/keymaps/rc-imon-rsc.c             |   2 +
 drivers/media/rc/keymaps/rc-xbox-360.c             |   2 +
 drivers/media/rc/lirc_dev.c                        |   6 +-
 drivers/media/rc/rc-ir-raw.c                       |   2 +
 drivers/media/rc/rc-main.c                         |   2 +
 drivers/media/rc/serial_ir.c                       |   2 +
 drivers/media/spi/Makefile                         |   2 +-
 drivers/media/test-drivers/vidtv/vidtv_pes.c       |   2 +
 drivers/media/test-drivers/vidtv/vidtv_psi.c       |   2 +
 drivers/media/test-drivers/vivid/vivid-rds-gen.c   |   2 +
 drivers/media/test-drivers/vivid/vivid-vbi-gen.c   |   2 +
 drivers/media/usb/as102/Makefile                   |   2 +-
 drivers/media/usb/au0828/Makefile                  |   4 +-
 drivers/media/usb/au0828/au0828-dvb.c              |   2 +
 drivers/media/usb/au0828/au0828-video.c            |   2 +
 drivers/media/usb/b2c2/Makefile                    |   2 +-
 drivers/media/usb/cx231xx/Makefile                 |   4 +-
 drivers/media/usb/em28xx/Makefile                  |   4 +-
 drivers/media/usb/em28xx/em28xx-dvb.c              |   2 +-
 drivers/media/usb/go7007/Makefile                  |   2 +-
 drivers/media/usb/pvrusb2/Makefile                 |   4 +-
 drivers/media/usb/pvrusb2/pvrusb2-hdw.c            |   6 ++
 drivers/media/usb/s2255/s2255drv.c                 |   2 +
 drivers/media/usb/siano/Makefile                   |   2 +-
 drivers/media/usb/stk1160/stk1160-v4l.c            |   2 +
 drivers/media/usb/stk1160/stk1160-video.c          |   2 +
 drivers/media/usb/stk1160/stk1160.h                |   2 +-
 drivers/media/usb/tm6000/Makefile                  |   4 +-
 drivers/media/usb/ttusb-budget/Makefile            |   2 +-
 drivers/media/usb/uvc/uvc_driver.c                 |   2 +
 drivers/media/v4l2-core/v4l2-flash-led-class.c     |   2 +
 drivers/media/v4l2-core/v4l2-fwnode.c              |   2 +
 drivers/media/v4l2-core/v4l2-ioctl.c               |   2 +
 drivers/media/v4l2-core/videobuf2-dma-sg.c         |   2 +
 include/linux/kernel_version.h                     |   1 +
 include/linux/refcount.h                           | 102 +++++++++++++++++++++
 include/media/compat.h                             |  11 ++-
 include/media/config-mycompat.h                    |   3 +
 include/media/i2c/saa6588.h                        |   2 +
 include/media/media-devnode.h                      |   2 +
 include/media/media-entity.h                       |   2 +
 include/media/media-request.h                      |   2 +
 include/media/v4l2-ctrls.h                         |   2 +
 include/media/v4l2-dev.h                           |   5 +-
 include/media/v4l2-fwnode.h                        |   2 +
 include/media/videobuf-core.h                      |   2 +
 include/media/videobuf2-core.h                     |   3 +-
 126 files changed, 372 insertions(+), 69 deletions(-)
 create mode 100644 include/linux/kernel_version.h
 create mode 100644 include/linux/refcount.h

diff --git a/drivers/media/cec/core/cec-adap.c b/drivers/media/cec/core/cec-adap.c
index d5f7723..be25160 100644
--- a/drivers/media/cec/core/cec-adap.c
+++ b/drivers/media/cec/core/cec-adap.c
@@ -20,6 +20,8 @@
 #include <drm/drmP.h>
 #include <drm/drm_edid.h>
 
+#include <media/compat.h>
+
 #include "cec-priv.h"
 
 static void cec_fill_msg_report_features(struct cec_adapter *adap,
diff --git a/drivers/media/cec/core/cec-api.c b/drivers/media/cec/core/cec-api.c
index 1c30968..3f32138 100644
--- a/drivers/media/cec/core/cec-api.c
+++ b/drivers/media/cec/core/cec-api.c
@@ -19,6 +19,9 @@
 #include <linux/version.h>
 
 #include <media/cec-pin.h>
+
+#include <media/compat.h>
+
 #include "cec-priv.h"
 #include "cec-pin-priv.h"
 
diff --git a/drivers/media/cec/core/cec-core.c b/drivers/media/cec/core/cec-core.c
index af358e9..e97f2f9 100644
--- a/drivers/media/cec/core/cec-core.c
+++ b/drivers/media/cec/core/cec-core.c
@@ -15,6 +15,8 @@
 #include <linux/string.h>
 #include <linux/types.h>
 
+#include <media/compat.h>
+
 #include "cec-priv.h"
 
 #define CEC_NUM_DEVICES	256
diff --git a/drivers/media/cec/usb/pulse8/pulse8-cec.c b/drivers/media/cec/usb/pulse8/pulse8-cec.c
index 04b13cd..7321142 100644
--- a/drivers/media/cec/usb/pulse8/pulse8-cec.c
+++ b/drivers/media/cec/usb/pulse8/pulse8-cec.c
@@ -41,6 +41,8 @@
 
 #include <media/cec.h>
 
+#include <media/compat.h>
+
 MODULE_AUTHOR("Hans Verkuil <hverkuil@xs4all.nl>");
 MODULE_DESCRIPTION("Pulse Eight HDMI CEC driver");
 MODULE_LICENSE("GPL");
diff --git a/drivers/media/cec/usb/rainshadow/rainshadow-cec.c b/drivers/media/cec/usb/rainshadow/rainshadow-cec.c
index ee870ea..9e604db 100644
--- a/drivers/media/cec/usb/rainshadow/rainshadow-cec.c
+++ b/drivers/media/cec/usb/rainshadow/rainshadow-cec.c
@@ -31,6 +31,8 @@
 
 #include <media/cec.h>
 
+#include <media/compat.h>
+
 MODULE_AUTHOR("Hans Verkuil <hverkuil@xs4all.nl>");
 MODULE_DESCRIPTION("RainShadow Tech HDMI CEC driver");
 MODULE_LICENSE("GPL");
diff --git a/drivers/media/common/b2c2/Makefile b/drivers/media/common/b2c2/Makefile
index 0e32b77..342f6a8 100644
--- a/drivers/media/common/b2c2/Makefile
+++ b/drivers/media/common/b2c2/Makefile
@@ -4,5 +4,5 @@ b2c2-flexcop-objs += flexcop-sram.o flexcop-eeprom.o flexcop-misc.o
 b2c2-flexcop-objs += flexcop-hw-filter.o
 obj-$(CONFIG_DVB_B2C2_FLEXCOP) += b2c2-flexcop.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends/
-ccflags-y += -I $(srctree)/drivers/media/tuners/
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends/
+ccflags-y += -I$(srctree)/drivers/media/tuners/
diff --git a/drivers/media/common/saa7146/saa7146_fops.c b/drivers/media/common/saa7146/saa7146_fops.c
index bcaec92..37e1500 100644
--- a/drivers/media/common/saa7146/saa7146_fops.c
+++ b/drivers/media/common/saa7146/saa7146_fops.c
@@ -2,6 +2,8 @@
 // SPDX-License-Identifier: GPL-2.0-only
 #define pr_fmt(fmt) KBUILD_MODNAME ": " fmt
 
+#include <media/compat.h>
+
 #include <media/drv-intf/saa7146_vv.h>
 #include <linux/module.h>
 
diff --git a/drivers/media/common/saa7146/saa7146_vbi.c b/drivers/media/common/saa7146/saa7146_vbi.c
index 970ab3e..575b449 100644
--- a/drivers/media/common/saa7146/saa7146_vbi.c
+++ b/drivers/media/common/saa7146/saa7146_vbi.c
@@ -1,4 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0
+
+#include <media/compat.h>
+
 #include <media/drv-intf/saa7146_vv.h>
 
 static int vbi_pixel_to_capture = 720 * 2;
diff --git a/drivers/media/common/saa7146/saa7146_video.c b/drivers/media/common/saa7146/saa7146_video.c
index fe4b19c..4fe4ce5 100644
--- a/drivers/media/common/saa7146/saa7146_video.c
+++ b/drivers/media/common/saa7146/saa7146_video.c
@@ -7,6 +7,8 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 
+#include <media/compat.h>
+
 static int max_memory = 32;
 
 module_param(max_memory, int, 0644);
diff --git a/drivers/media/common/v4l2-tpg/v4l2-tpg-core.c b/drivers/media/common/v4l2-tpg/v4l2-tpg-core.c
index 7607b51..302a5e6 100644
--- a/drivers/media/common/v4l2-tpg/v4l2-tpg-core.c
+++ b/drivers/media/common/v4l2-tpg/v4l2-tpg-core.c
@@ -11,6 +11,8 @@
 #include <linux/module.h>
 #include <media/tpg/v4l2-tpg.h>
 
+#include <media/compat.h>
+
 /* Must remain in sync with enum tpg_pattern */
 const char * const tpg_pattern_strings[] = {
 	"75% Colorbar",
diff --git a/drivers/media/common/videobuf2/frame_vector.c b/drivers/media/common/videobuf2/frame_vector.c
index 4aa700d..8c839b8 100644
--- a/drivers/media/common/videobuf2/frame_vector.c
+++ b/drivers/media/common/videobuf2/frame_vector.c
@@ -8,7 +8,9 @@
 #include <linux/pagemap.h>
 #include <linux/sched.h>
 
-#include <media/frame_vector.h>
+//#include <media/frame_vector.h>
+
+#include <media/compat.h>
 
 /**
  * get_vaddr_frames() - map virtual addresses to pfns
@@ -32,7 +34,7 @@
  *
  * This function takes care of grabbing mmap_lock as necessary.
  */
-int get_vaddr_frames(unsigned long start, unsigned int nr_frames,
+int get_vaddr_frames(unsigned long start, unsigned int nr_frames, unsigned int flags,
 		     struct frame_vector *vec)
 {
 	struct mm_struct *mm = current->mm;
diff --git a/drivers/media/common/videobuf2/videobuf2-dma-sg.c b/drivers/media/common/videobuf2/videobuf2-dma-sg.c
index 08d35df..2bdc259 100644
--- a/drivers/media/common/videobuf2/videobuf2-dma-sg.c
+++ b/drivers/media/common/videobuf2/videobuf2-dma-sg.c
@@ -21,6 +21,8 @@
 #include <media/videobuf2-memops.h>
 #include <media/videobuf2-dma-sg.h>
 
+#include <media/compat.h>
+
 static int debug;
 module_param(debug, int, 0644);
 
diff --git a/drivers/media/common/videobuf2/videobuf2-memops.c b/drivers/media/common/videobuf2/videobuf2-memops.c
index 5ccb3a3..e83941d 100644
--- a/drivers/media/common/videobuf2/videobuf2-memops.c
+++ b/drivers/media/common/videobuf2/videobuf2-memops.c
@@ -22,6 +22,8 @@
 #include <media/videobuf2-v4l2.h>
 #include <media/videobuf2-memops.h>
 
+#include <media/compat.h>
+
 /**
  * vb2_create_framevec() - map virtual addresses to pfns
  * @start:	Virtual user address where we start mapping
@@ -40,6 +42,7 @@ struct frame_vector *vb2_create_framevec(unsigned long start,
 	unsigned long first, last;
 	unsigned long nr;
 	struct frame_vector *vec;
+	unsigned int flags = FOLL_FORCE;
 
 	first = start >> PAGE_SHIFT;
 	last = (start + length - 1) >> PAGE_SHIFT;
@@ -47,7 +50,7 @@ struct frame_vector *vb2_create_framevec(unsigned long start,
 	vec = frame_vector_create(nr);
 	if (!vec)
 		return ERR_PTR(-ENOMEM);
-	ret = get_vaddr_frames(start & PAGE_MASK, nr, vec);
+	ret = get_vaddr_frames(start & PAGE_MASK, nr, flags, vec);
 	if (ret < 0)
 		goto out_destroy;
 	/* We accept only complete set of PFNs */
diff --git a/drivers/media/dvb-core/dmxdev.c b/drivers/media/dvb-core/dmxdev.c
index 6198d6f..aed0d08 100644
--- a/drivers/media/dvb-core/dmxdev.c
+++ b/drivers/media/dvb-core/dmxdev.c
@@ -21,6 +21,8 @@
 #include <media/dmxdev.h>
 #include <media/dvb_vb2.h>
 
+#include <media/compat.h>
+
 static int debug;
 
 module_param(debug, int, 0644);
diff --git a/drivers/media/dvb-core/dvb_demux.c b/drivers/media/dvb-core/dvb_demux.c
index 2028dc2..00036d0 100644
--- a/drivers/media/dvb-core/dvb_demux.c
+++ b/drivers/media/dvb-core/dvb_demux.c
@@ -23,6 +23,8 @@
 
 #include <media/dvb_demux.h>
 
+#include <media/compat.h>
+
 static int dvb_demux_tscheck;
 module_param(dvb_demux_tscheck, int, 0644);
 MODULE_PARM_DESC(dvb_demux_tscheck,
diff --git a/drivers/media/dvb-core/dvb_net.c b/drivers/media/dvb-core/dvb_net.c
index b9a2af1..a5b3701 100644
--- a/drivers/media/dvb-core/dvb_net.c
+++ b/drivers/media/dvb-core/dvb_net.c
@@ -54,6 +54,8 @@
 #include <linux/mutex.h>
 #include <linux/sched.h>
 
+#include <media/compat.h>
+
 #include <media/dvb_demux.h>
 #include <media/dvb_net.h>
 
diff --git a/drivers/media/dvb-frontends/mn88443x.c b/drivers/media/dvb-frontends/mn88443x.c
index fff212c..ecfd8c7 100644
--- a/drivers/media/dvb-frontends/mn88443x.c
+++ b/drivers/media/dvb-frontends/mn88443x.c
@@ -4,7 +4,7 @@
 //
 // Copyright (c) 2018 Socionext Inc.
 
-#include <linux/bitfield.h>
+// #include <linux/bitfield.h>
 #include <linux/clk.h>
 #include <linux/delay.h>
 #include <linux/gpio/consumer.h>
@@ -12,6 +12,8 @@
 #include <linux/regmap.h>
 #include <media/dvb_math.h>
 
+#include <media/compat.h>
+
 #include "mn88443x.h"
 
 /* ISDB-S registers */
diff --git a/drivers/media/i2c/Kconfig b/drivers/media/i2c/Kconfig
index 2b20aa6..3521f99 100644
--- a/drivers/media/i2c/Kconfig
+++ b/drivers/media/i2c/Kconfig
@@ -434,6 +434,7 @@ config VIDEO_OV5640
 	tristate "OmniVision OV5640 sensor support"
 	depends on OF
 	depends on GPIOLIB && VIDEO_DEV && I2C
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	select MEDIA_CONTROLLER
 	select VIDEO_V4L2_SUBDEV_API
 	select V4L2_FWNODE
@@ -445,6 +446,7 @@ config VIDEO_OV5645
 	tristate "OmniVision OV5645 sensor support"
 	depends on OF
 	depends on I2C && VIDEO_DEV
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	select MEDIA_CONTROLLER
 	select VIDEO_V4L2_SUBDEV_API
 	select V4L2_FWNODE
@@ -1085,6 +1087,7 @@ config VIDEO_ADV748X
 	tristate "Analog Devices ADV748x decoder"
 	depends on VIDEO_DEV && I2C
 	depends on OF
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	select MEDIA_CONTROLLER
 	select VIDEO_V4L2_SUBDEV_API
 	select REGMAP_I2C
@@ -1271,6 +1274,7 @@ config VIDEO_TVP514X
 config VIDEO_TVP5150
 	tristate "Texas Instruments TVP5150 video decoder"
 	depends on VIDEO_DEV && I2C
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	select V4L2_FWNODE
 	select REGMAP_I2C
 	help
@@ -1534,7 +1538,7 @@ config VIDEO_I2C
 	tristate "I2C transport video support"
 	depends on VIDEO_DEV && I2C
 	select VIDEOBUF2_VMALLOC
-	imply HWMON
+#	imply HWMON
 	help
 	  Enable the I2C transport video support which supports the
 	  following:
diff --git a/drivers/media/i2c/adv7604.c b/drivers/media/i2c/adv7604.c
index bb0c8fc..e34f0e8 100644
--- a/drivers/media/i2c/adv7604.c
+++ b/drivers/media/i2c/adv7604.c
@@ -2484,7 +2484,7 @@ static int adv76xx_read_infoframe(struct v4l2_subdev *sd, int index,
 		buffer[i + 3] = infoframe_read(sd,
 				       adv76xx_cri[index].payload_addr + i);
 
-	if (hdmi_infoframe_unpack(frame, buffer, len + 3) < 0) {
+	if (hdmi_infoframe_unpack(frame, buffer) < 0) {
 		v4l2_err(sd, "%s: unpack of %s infoframe failed\n", __func__,
 			 adv76xx_cri[index].desc);
 		return -ENOENT;
diff --git a/drivers/media/i2c/adv7842.c b/drivers/media/i2c/adv7842.c
index 22caa07..ac12182 100644
--- a/drivers/media/i2c/adv7842.c
+++ b/drivers/media/i2c/adv7842.c
@@ -2583,7 +2583,7 @@ static void log_infoframe(struct v4l2_subdev *sd, const struct adv7842_cfg_read_
 	for (i = 0; i < len; i++)
 		buffer[i + 3] = infoframe_read(sd, cri->payload_addr + i);
 
-	if (hdmi_infoframe_unpack(&frame, buffer, len + 3) < 0) {
+	if (hdmi_infoframe_unpack(&frame, buffer) < 0) {
 		v4l2_err(sd, "%s: unpack of %s infoframe failed\n", __func__, cri->desc);
 		return;
 	}
diff --git a/drivers/media/i2c/ak7375.c b/drivers/media/i2c/ak7375.c
index 40b1a4a..e2b4ab6 100644
--- a/drivers/media/i2c/ak7375.c
+++ b/drivers/media/i2c/ak7375.c
@@ -9,6 +9,8 @@
 #include <media/v4l2-ctrls.h>
 #include <media/v4l2-device.h>
 
+#include <media/compat.h>
+
 #define AK7375_MAX_FOCUS_POS	4095
 /*
  * This sets the minimum granularity for the focus positions.
diff --git a/drivers/media/i2c/ir-kbd-i2c.c b/drivers/media/i2c/ir-kbd-i2c.c
index 5667417..6701640 100644
--- a/drivers/media/i2c/ir-kbd-i2c.c
+++ b/drivers/media/i2c/ir-kbd-i2c.c
@@ -50,6 +50,8 @@
 #include <media/rc-core.h>
 #include <media/i2c/ir-kbd-i2c.h>
 
+#include <media/compat.h>
+
 #define FLAG_TX		1
 #define FLAG_HDPVR	2
 
diff --git a/drivers/media/i2c/ov7740.c b/drivers/media/i2c/ov7740.c
index 444aa2d..d93d3f6 100644
--- a/drivers/media/i2c/ov7740.c
+++ b/drivers/media/i2c/ov7740.c
@@ -13,6 +13,8 @@
 #include <media/v4l2-image-sizes.h>
 #include <media/v4l2-subdev.h>
 
+#include <media/compat.h>
+
 #define REG_OUTSIZE_LSB 0x34
 
 /* OV7740 register tables */
diff --git a/drivers/media/i2c/smiapp/smiapp.h b/drivers/media/i2c/smiapp/smiapp.h
index ed010a8..6bbfe11 100644
--- a/drivers/media/i2c/smiapp/smiapp.h
+++ b/drivers/media/i2c/smiapp/smiapp.h
@@ -24,7 +24,7 @@
 #include <media/v4l2-subdev.h>
 #include <media/smiapp.h>
 
-#include "smiapp-pll.h"
+#include "../smiapp-pll.h"
 #include "smiapp-reg.h"
 #include "smiapp-regs.h"
 #include "smiapp-quirk.h"
diff --git a/drivers/media/i2c/tc358743.c b/drivers/media/i2c/tc358743.c
index 5a79b40..45dc8f7 100644
--- a/drivers/media/i2c/tc358743.c
+++ b/drivers/media/i2c/tc358743.c
@@ -444,7 +444,7 @@ static void print_avi_infoframe(struct v4l2_subdev *sd)
 
 	i2c_rd(sd, PK_AVI_0HEAD, buffer, HDMI_INFOFRAME_SIZE(AVI));
 
-	if (hdmi_infoframe_unpack(&frame, buffer, sizeof(buffer)) < 0) {
+	if (hdmi_infoframe_unpack(&frame, buffer) < 0) {
 		v4l2_err(sd, "%s: unpack of AVI infoframe failed\n", __func__);
 		return;
 	}
diff --git a/drivers/media/i2c/tda1997x.c b/drivers/media/i2c/tda1997x.c
index 44a2294..2311f4d 100644
--- a/drivers/media/i2c/tda1997x.c
+++ b/drivers/media/i2c/tda1997x.c
@@ -30,6 +30,8 @@
 
 #include <dt-bindings/media/tda1997x.h>
 
+#include <media/compat.h>
+
 #include "tda1997x_regs.h"
 
 #define TDA1997X_MBUS_CODES	5
@@ -1269,7 +1271,7 @@ tda1997x_parse_infoframe(struct tda1997x_state *state, u16 addr)
 
 	/* read data */
 	len = io_readn(sd, addr, sizeof(buffer), buffer);
-	err = hdmi_infoframe_unpack(&frame, buffer, len);
+	err = hdmi_infoframe_unpack(&frame, buffer);
 	if (err) {
 		v4l_err(state->client,
 			"failed parsing %d byte infoframe: 0x%04x/0x%02x\n",
@@ -1949,7 +1951,7 @@ static int tda1997x_log_infoframe(struct v4l2_subdev *sd, int addr)
 	/* read data */
 	len = io_readn(sd, addr, sizeof(buffer), buffer);
 	v4l2_dbg(1, debug, sd, "infoframe: addr=%d len=%d\n", addr, len);
-	err = hdmi_infoframe_unpack(&frame, buffer, len);
+	err = hdmi_infoframe_unpack(&frame, buffer);
 	if (err) {
 		v4l_err(state->client,
 			"failed parsing %d byte infoframe: 0x%04x/0x%02x\n",
diff --git a/drivers/media/i2c/tvaudio.c b/drivers/media/i2c/tvaudio.c
index e6796e9..fbc3be2 100644
--- a/drivers/media/i2c/tvaudio.c
+++ b/drivers/media/i2c/tvaudio.c
@@ -40,6 +40,8 @@
 #include <media/v4l2-device.h>
 #include <media/v4l2-ctrls.h>
 
+#include <media/compat.h>
+
 /* ---------------------------------------------------------------------- */
 /* insmod args                                                            */
 
diff --git a/drivers/media/i2c/tvp5150.c b/drivers/media/i2c/tvp5150.c
index ba10fb4..fbd53f3 100644
--- a/drivers/media/i2c/tvp5150.c
+++ b/drivers/media/i2c/tvp5150.c
@@ -95,6 +95,13 @@ struct tvp5150 {
 	enum v4l2_mbus_type mbus_type;
 };
 
+#ifdef __BIG_ENDIAN
+int of_graph_get_endpoint_count(const struct device_node *np)
+{
+	return 0;
+}
+#endif
+
 static inline struct tvp5150 *to_tvp5150(struct v4l2_subdev *sd)
 {
 	return container_of(sd, struct tvp5150, sd);
diff --git a/drivers/media/media-device.c b/drivers/media/media-device.c
index 0ca9506..b17c79e 100644
--- a/drivers/media/media-device.c
+++ b/drivers/media/media-device.c
@@ -31,6 +31,8 @@
 #include <media/media-devnode.h>
 #include <media/media-entity.h>
 
+#include <media/compat.h>
+
 /* -----------------------------------------------------------------------------
  * Userspace API
  */
diff --git a/drivers/media/mmc/siano/Makefile b/drivers/media/mmc/siano/Makefile
index 88cb8be..4349581 100644
--- a/drivers/media/mmc/siano/Makefile
+++ b/drivers/media/mmc/siano/Makefile
@@ -1,4 +1,4 @@
 # SPDX-License-Identifier: GPL-2.0-only
 obj-$(CONFIG_SMS_SDIO_DRV) += smssdio.o
 
-ccflags-y += -I $(srctree)/drivers/media/common/siano
+ccflags-y += -I$(srctree)/drivers/media/common/siano
diff --git a/drivers/media/pci/b2c2/Makefile b/drivers/media/pci/b2c2/Makefile
index 14ed6e4..41d2fe8 100644
--- a/drivers/media/pci/b2c2/Makefile
+++ b/drivers/media/pci/b2c2/Makefile
@@ -6,4 +6,4 @@ endif
 b2c2-flexcop-pci-objs += flexcop-pci.o
 obj-$(CONFIG_DVB_B2C2_FLEXCOP_PCI) += b2c2-flexcop-pci.o
 
-ccflags-y += -I $(srctree)/drivers/media/common/b2c2/
+ccflags-y += -I$(srctree)/drivers/media/common/b2c2/
diff --git a/drivers/media/pci/bt8xx/Makefile b/drivers/media/pci/bt8xx/Makefile
index 69bc0d9..2c290ff 100644
--- a/drivers/media/pci/bt8xx/Makefile
+++ b/drivers/media/pci/bt8xx/Makefile
@@ -6,5 +6,5 @@ bttv-objs      :=      bttv-driver.o bttv-cards.o bttv-if.o \
 obj-$(CONFIG_VIDEO_BT848) += bttv.o
 obj-$(CONFIG_DVB_BT8XX) += bt878.o dvb-bt8xx.o dst.o dst_ca.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
-ccflags-y += -I $(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
diff --git a/drivers/media/pci/bt8xx/bttv-driver.c b/drivers/media/pci/bt8xx/bttv-driver.c
index 9f980d8..cdb965c 100644
--- a/drivers/media/pci/bt8xx/bttv-driver.c
+++ b/drivers/media/pci/bt8xx/bttv-driver.c
@@ -49,6 +49,8 @@
 
 #include <media/i2c/saa6588.h>
 
+#include <media/compat.h>
+
 #define BTTV_VERSION "0.9.19"
 
 unsigned int bttv_num;			/* number of Bt848s in use */
diff --git a/drivers/media/pci/bt8xx/bttv-input.c b/drivers/media/pci/bt8xx/bttv-input.c
index 1bf8fe4..f3b10dd 100644
--- a/drivers/media/pci/bt8xx/bttv-input.c
+++ b/drivers/media/pci/bt8xx/bttv-input.c
@@ -18,6 +18,7 @@
 #include "bttv.h"
 #include "bttvp.h"
 
+#include <media/compat.h>
 
 static int ir_debug;
 module_param(ir_debug, int, 0644);
diff --git a/drivers/media/pci/cx18/Makefile b/drivers/media/pci/cx18/Makefile
index df00ef8..2191f8c 100644
--- a/drivers/media/pci/cx18/Makefile
+++ b/drivers/media/pci/cx18/Makefile
@@ -9,5 +9,5 @@ cx18-alsa-objs := cx18-alsa-main.o cx18-alsa-pcm.o
 obj-$(CONFIG_VIDEO_CX18) += cx18.o
 obj-$(CONFIG_VIDEO_CX18_ALSA) += cx18-alsa.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
-ccflags-y += -I $(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
diff --git a/drivers/media/pci/cx18/cx18-fileops.c b/drivers/media/pci/cx18/cx18-fileops.c
index 4cf5b9c..207b43a 100644
--- a/drivers/media/pci/cx18/cx18-fileops.c
+++ b/drivers/media/pci/cx18/cx18-fileops.c
@@ -22,6 +22,8 @@
 #include "cx18-cards.h"
 #include <media/v4l2-event.h>
 
+#include <media/compat.h>
+
 /* This function tries to claim the stream for a specific file descriptor.
    If no one else is using this stream then the stream is claimed and
    associated VBI and IDX streams are also automatically claimed.
diff --git a/drivers/media/pci/cx18/cx18-streams.c b/drivers/media/pci/cx18/cx18-streams.c
index 87ff554..8bab634 100644
--- a/drivers/media/pci/cx18/cx18-streams.c
+++ b/drivers/media/pci/cx18/cx18-streams.c
@@ -20,6 +20,8 @@
 #include "cx18-scb.h"
 #include "cx18-dvb.h"
 
+#include <media/compat.h>
+
 #define CX18_DSP0_INTERRUPT_MASK	0xd0004C
 
 static const struct v4l2_file_operations cx18_v4l2_enc_fops = {
diff --git a/drivers/media/pci/cx23885/Makefile b/drivers/media/pci/cx23885/Makefile
index a785169..c42e3b1 100644
--- a/drivers/media/pci/cx23885/Makefile
+++ b/drivers/media/pci/cx23885/Makefile
@@ -8,7 +8,7 @@ cx23885-objs	:= cx23885-cards.o cx23885-video.o cx23885-vbi.o \
 obj-$(CONFIG_VIDEO_CX23885) += cx23885.o
 obj-$(CONFIG_MEDIA_ALTERA_CI) += altera-ci.o
 
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
 
 ccflags-y += $(extra-cflags-y) $(extra-cflags-m)
diff --git a/drivers/media/pci/cx88/Makefile b/drivers/media/pci/cx88/Makefile
index c2a0158..d0f45d6 100644
--- a/drivers/media/pci/cx88/Makefile
+++ b/drivers/media/pci/cx88/Makefile
@@ -10,5 +10,5 @@ obj-$(CONFIG_VIDEO_CX88_ALSA) += cx88-alsa.o
 obj-$(CONFIG_VIDEO_CX88_BLACKBIRD) += cx88-blackbird.o
 obj-$(CONFIG_VIDEO_CX88_DVB) += cx88-dvb.o
 obj-$(CONFIG_VIDEO_CX88_VP3054) += cx88-vp3054-i2c.o
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -Idrivers/media/tuners
+ccflags-y += -Idrivers/media/dvb-frontends
diff --git a/drivers/media/pci/ddbridge/Makefile b/drivers/media/pci/ddbridge/Makefile
index 5e7eab8..ad9b7cf 100644
--- a/drivers/media/pci/ddbridge/Makefile
+++ b/drivers/media/pci/ddbridge/Makefile
@@ -9,5 +9,5 @@ ddbridge-objs := ddbridge-main.o ddbridge-core.o ddbridge-ci.o \
 
 obj-$(CONFIG_DVB_DDBRIDGE) += ddbridge.o ddbridge-dummy-fe.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends/
-ccflags-y += -I $(srctree)/drivers/media/tuners/
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends/
+ccflags-y += -I$(srctree)/drivers/media/tuners/
diff --git a/drivers/media/pci/ddbridge/ddbridge-core.c b/drivers/media/pci/ddbridge/ddbridge-core.c
index 92fe051..2c6168f 100644
--- a/drivers/media/pci/ddbridge/ddbridge-core.c
+++ b/drivers/media/pci/ddbridge/ddbridge-core.c
@@ -30,6 +30,8 @@
 #include <linux/swab.h>
 #include <linux/vmalloc.h>
 
+#include <media/compat.h>
+
 #include "ddbridge.h"
 #include "ddbridge-i2c.h"
 #include "ddbridge-regs.h"
diff --git a/drivers/media/pci/dm1105/Makefile b/drivers/media/pci/dm1105/Makefile
index bf80409..04a5801 100644
--- a/drivers/media/pci/dm1105/Makefile
+++ b/drivers/media/pci/dm1105/Makefile
@@ -1,4 +1,4 @@
 # SPDX-License-Identifier: GPL-2.0-only
 obj-$(CONFIG_DVB_DM1105) += dm1105.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -Idrivers/media/dvb-frontends
diff --git a/drivers/media/pci/ivtv/ivtv-driver.c b/drivers/media/pci/ivtv/ivtv-driver.c
index f064d9d..1fbc8eb 100644
--- a/drivers/media/pci/ivtv/ivtv-driver.c
+++ b/drivers/media/pci/ivtv/ivtv-driver.c
@@ -59,6 +59,8 @@
 #include <media/i2c/saa7115.h>
 #include "xc2028.h"
 
+#include <media/compat.h>
+
 /* If you have already X v4l cards, then set this to X. This way
    the device numbers stay matched. Example: you have a WinTV card
    without radio and a PVR-350 with. Normally this would give a
diff --git a/drivers/media/pci/ivtv/ivtv-irq.c b/drivers/media/pci/ivtv/ivtv-irq.c
index b7aaa8b..8363f19 100644
--- a/drivers/media/pci/ivtv/ivtv-irq.c
+++ b/drivers/media/pci/ivtv/ivtv-irq.c
@@ -15,6 +15,8 @@
 #include "ivtv-yuv.h"
 #include <media/v4l2-event.h>
 
+#include <media/compat.h>
+
 #define DMA_MAGIC_COOKIE 0x000001fe
 
 static void ivtv_dma_dec_start(struct ivtv_stream *s);
diff --git a/drivers/media/pci/mantis/Makefile b/drivers/media/pci/mantis/Makefile
index 49e8224..4feb820 100644
--- a/drivers/media/pci/mantis/Makefile
+++ b/drivers/media/pci/mantis/Makefile
@@ -26,4 +26,4 @@ obj-$(CONFIG_MANTIS_CORE)	+= mantis_core.o
 obj-$(CONFIG_DVB_MANTIS)	+= mantis.o
 obj-$(CONFIG_DVB_HOPPER)	+= hopper.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends/
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends/
diff --git a/drivers/media/pci/netup_unidvb/Makefile b/drivers/media/pci/netup_unidvb/Makefile
index 215bdaf..944c3e1 100644
--- a/drivers/media/pci/netup_unidvb/Makefile
+++ b/drivers/media/pci/netup_unidvb/Makefile
@@ -6,4 +6,4 @@ netup-unidvb-objs += netup_unidvb_spi.o
 
 obj-$(CONFIG_DVB_NETUP_UNIDVB) += netup-unidvb.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -Idrivers/media/dvb-frontends
diff --git a/drivers/media/pci/netup_unidvb/netup_unidvb_core.c b/drivers/media/pci/netup_unidvb/netup_unidvb_core.c
index 8287851..a7e650d 100644
--- a/drivers/media/pci/netup_unidvb/netup_unidvb_core.c
+++ b/drivers/media/pci/netup_unidvb/netup_unidvb_core.c
@@ -28,6 +28,8 @@
 #include "helene.h"
 #include "lnbh25.h"
 
+#include <media/compat.h>
+
 static int spi_enable;
 module_param(spi_enable, int, S_IRUSR | S_IWUSR | S_IRGRP | S_IROTH);
 
diff --git a/drivers/media/pci/ngene/Makefile b/drivers/media/pci/ngene/Makefile
index 5d16090..ec860a7 100644
--- a/drivers/media/pci/ngene/Makefile
+++ b/drivers/media/pci/ngene/Makefile
@@ -7,5 +7,5 @@ ngene-objs := ngene-core.o ngene-i2c.o ngene-cards.o ngene-dvb.o
 
 obj-$(CONFIG_DVB_NGENE) += ngene.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends/
-ccflags-y += -I $(srctree)/drivers/media/tuners/
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends/
+ccflags-y += -I$(srctree)/drivers/media/tuners/
diff --git a/drivers/media/pci/pluto2/Makefile b/drivers/media/pci/pluto2/Makefile
index 0553479..5d0b52f 100644
--- a/drivers/media/pci/pluto2/Makefile
+++ b/drivers/media/pci/pluto2/Makefile
@@ -1,4 +1,4 @@
 # SPDX-License-Identifier: GPL-2.0-only
 obj-$(CONFIG_DVB_PLUTO2) += pluto2.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends/
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends/
diff --git a/drivers/media/pci/pt1/Makefile b/drivers/media/pci/pt1/Makefile
index 45b21a9..b468bff 100644
--- a/drivers/media/pci/pt1/Makefile
+++ b/drivers/media/pci/pt1/Makefile
@@ -3,5 +3,5 @@ earth-pt1-objs := pt1.o
 
 obj-$(CONFIG_DVB_PT1) += earth-pt1.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
-ccflags-y += -I $(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
diff --git a/drivers/media/pci/pt3/Makefile b/drivers/media/pci/pt3/Makefile
index da6b265..de31f91 100644
--- a/drivers/media/pci/pt3/Makefile
+++ b/drivers/media/pci/pt3/Makefile
@@ -4,5 +4,5 @@ earth-pt3-objs += pt3.o pt3_i2c.o pt3_dma.o
 
 obj-$(CONFIG_DVB_PT3) += earth-pt3.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
-ccflags-y += -I $(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
diff --git a/drivers/media/pci/saa7134/saa7134-core.c b/drivers/media/pci/saa7134/saa7134-core.c
index 96328b0..cb4e249 100644
--- a/drivers/media/pci/saa7134/saa7134-core.c
+++ b/drivers/media/pci/saa7134/saa7134-core.c
@@ -23,6 +23,8 @@
 #include <linux/dma-mapping.h>
 #include <linux/pm.h>
 
+#include <media/compat.h>
+
 MODULE_DESCRIPTION("v4l2 driver module for saa7130/34 based TV cards");
 MODULE_AUTHOR("Gerd Knorr <kraxel@bytesex.org> [SuSE Labs]");
 MODULE_LICENSE("GPL");
diff --git a/drivers/media/pci/saa7134/saa7134-input.c b/drivers/media/pci/saa7134/saa7134-input.c
index 8610eb4..70ff329 100644
--- a/drivers/media/pci/saa7134/saa7134-input.c
+++ b/drivers/media/pci/saa7134/saa7134-input.c
@@ -13,6 +13,8 @@
 #include <linux/interrupt.h>
 #include <linux/slab.h>
 
+#include <media/compat.h>
+
 #define MODULE_NAME "saa7134"
 
 static unsigned int disable_ir;
diff --git a/drivers/media/pci/saa7134/saa7134-ts.c b/drivers/media/pci/saa7134/saa7134-ts.c
index 6a50531..24bb6de 100644
--- a/drivers/media/pci/saa7134/saa7134-ts.c
+++ b/drivers/media/pci/saa7134/saa7134-ts.c
@@ -16,6 +16,8 @@
 #include <linux/kernel.h>
 #include <linux/delay.h>
 
+#include <media/compat.h>
+
 /* ------------------------------------------------------------------ */
 
 static unsigned int ts_debug;
diff --git a/drivers/media/pci/saa7134/saa7134-vbi.c b/drivers/media/pci/saa7134/saa7134-vbi.c
index 3f0b093..a1f3cd4 100644
--- a/drivers/media/pci/saa7134/saa7134-vbi.c
+++ b/drivers/media/pci/saa7134/saa7134-vbi.c
@@ -15,6 +15,8 @@
 #include <linux/module.h>
 #include <linux/kernel.h>
 
+#include <media/compat.h>
+
 /* ------------------------------------------------------------------ */
 
 static unsigned int vbi_debug;
diff --git a/drivers/media/pci/saa7134/saa7134-video.c b/drivers/media/pci/saa7134/saa7134-video.c
index 4d8974c..d7707cf 100644
--- a/drivers/media/pci/saa7134/saa7134-video.c
+++ b/drivers/media/pci/saa7134/saa7134-video.c
@@ -21,6 +21,8 @@
 #include <media/v4l2-event.h>
 #include <media/i2c/saa6588.h>
 
+#include <media/compat.h>
+
 /* ------------------------------------------------------------------ */
 
 unsigned int video_debug;
diff --git a/drivers/media/pci/smipcie/Makefile b/drivers/media/pci/smipcie/Makefile
index 2426b75..bb474df 100644
--- a/drivers/media/pci/smipcie/Makefile
+++ b/drivers/media/pci/smipcie/Makefile
@@ -4,5 +4,5 @@ smipcie-objs	:= smipcie-main.o smipcie-ir.o
 
 obj-$(CONFIG_DVB_SMIPCIE) += smipcie.o
 
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
diff --git a/drivers/media/pci/solo6x10/solo6x10-gpio.c b/drivers/media/pci/solo6x10/solo6x10-gpio.c
index 084c307..36f6054 100644
--- a/drivers/media/pci/solo6x10/solo6x10-gpio.c
+++ b/drivers/media/pci/solo6x10/solo6x10-gpio.c
@@ -16,6 +16,10 @@
 
 #include "solo6x10.h"
 
+#ifdef CONFIG_GPIOLIB
+#undef CONFIG_GPIOLIB
+#endif
+
 static void solo_gpio_mode(struct solo_dev *solo_dev,
 			   unsigned int port_mask, unsigned int mode)
 {
@@ -98,7 +102,7 @@ static int solo_gpiochip_get_direction(struct gpio_chip *chip,
 				       unsigned int offset)
 {
 	int ret, mode;
-	struct solo_dev *solo_dev = gpiochip_get_data(chip);
+	struct solo_dev *solo_dev = container_of(chip, struct solo_dev, gpio_chip);
 
 	if (offset < 8) {
 		ret = solo_reg_read(solo_dev, SOLO_GPIO_CONFIG_0);
@@ -132,7 +136,8 @@ static int solo_gpiochip_get(struct gpio_chip *chip,
 						unsigned int offset)
 {
 	int ret;
-	struct solo_dev *solo_dev = gpiochip_get_data(chip);
+	struct solo_dev *solo_dev = container_of(chip, struct solo_dev, gpio_chip);
+//gpiochip_get_data(chip);
 
 	ret = solo_reg_read(solo_dev, SOLO_GPIO_DATA_IN);
 
diff --git a/drivers/media/pci/ttpci/Makefile b/drivers/media/pci/ttpci/Makefile
index b0708f6..014a7b2 100644
--- a/drivers/media/pci/ttpci/Makefile
+++ b/drivers/media/pci/ttpci/Makefile
@@ -8,6 +8,6 @@ obj-$(CONFIG_DVB_BUDGET) += budget.o
 obj-$(CONFIG_DVB_BUDGET_AV) += budget-av.o
 obj-$(CONFIG_DVB_BUDGET_CI) += budget-ci.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends/
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/common
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends/
+ccflags-y += -I$(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/common
diff --git a/drivers/media/pci/ttpci/av7110_ipack.c b/drivers/media/pci/ttpci/av7110_ipack.c
index 699ef8b..c1da646 100644
--- a/drivers/media/pci/ttpci/av7110_ipack.c
+++ b/drivers/media/pci/ttpci/av7110_ipack.c
@@ -3,6 +3,7 @@
 #include <linux/string.h>	/* for memcpy() */
 #include <linux/vmalloc.h>
 
+#include <media/compat.h>
 
 void av7110_ipack_reset(struct ipack *p)
 {
diff --git a/drivers/media/pci/ttpci/av7110_ir.c b/drivers/media/pci/ttpci/av7110_ir.c
index 0e763a7..a50a230 100644
--- a/drivers/media/pci/ttpci/av7110_ir.c
+++ b/drivers/media/pci/ttpci/av7110_ir.c
@@ -29,6 +29,8 @@
 #include <linux/kernel.h>
 #include <linux/bitops.h>
 
+#include <media/compath.h>
+
 #include "av7110.h"
 #include "av7110_hw.h"
 
diff --git a/drivers/media/pci/tw686x/tw686x-core.c b/drivers/media/pci/tw686x/tw686x-core.c
index f839302..ea28215 100644
--- a/drivers/media/pci/tw686x/tw686x-core.c
+++ b/drivers/media/pci/tw686x/tw686x-core.c
@@ -40,6 +40,8 @@
 #include "tw686x.h"
 #include "tw686x-regs.h"
 
+#include <media/compat.h>
+
 /*
  * This module parameter allows to control the DMA_TIMER_INTERVAL value.
  * The DMA_TIMER_INTERVAL register controls the minimum DMA interrupt
diff --git a/drivers/media/platform/Kconfig b/drivers/media/platform/Kconfig
index f1056ce..39965f2 100644
--- a/drivers/media/platform/Kconfig
+++ b/drivers/media/platform/Kconfig
@@ -54,6 +54,7 @@ config VIDEO_MUX
 	depends on V4L_PLATFORM_DRIVERS
 	select MULTIPLEXER
 	depends on VIDEO_DEV && OF
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	select MEDIA_CONTROLLER
 	select VIDEO_V4L2_SUBDEV_API
 	select REGMAP
diff --git a/drivers/media/platform/vim2m.c b/drivers/media/platform/vim2m.c
index e18fb9f..d94d799 100644
--- a/drivers/media/platform/vim2m.c
+++ b/drivers/media/platform/vim2m.c
@@ -31,6 +31,8 @@
 #include <media/v4l2-event.h>
 #include <media/videobuf2-vmalloc.h>
 
+#include <media/compat.h>
+
 MODULE_DESCRIPTION("Virtual device for mem2mem framework testing");
 MODULE_AUTHOR("Pawel Osciak, <pawel@osciak.com>");
 MODULE_LICENSE("GPL");
diff --git a/drivers/media/platform/vivid/vivid-rds-gen.c b/drivers/media/platform/vivid/vivid-rds-gen.c
index c382343..b9b9b9e 100644
--- a/drivers/media/platform/vivid/vivid-rds-gen.c
+++ b/drivers/media/platform/vivid/vivid-rds-gen.c
@@ -24,6 +24,8 @@
 
 #include "vivid-rds-gen.h"
 
+#include <media/compat.h>
+
 static u8 vivid_get_di(const struct vivid_rds_gen *rds, unsigned grp)
 {
 	switch (grp) {
diff --git a/drivers/media/platform/vivid/vivid-vbi-gen.c b/drivers/media/platform/vivid/vivid-vbi-gen.c
index a2159de..13ef0b1 100644
--- a/drivers/media/platform/vivid/vivid-vbi-gen.c
+++ b/drivers/media/platform/vivid/vivid-vbi-gen.c
@@ -25,6 +25,8 @@
 
 #include "vivid-vbi-gen.h"
 
+#include <media/compat.h>
+
 static void wss_insert(u8 *wss, u32 val, unsigned size)
 {
 	while (size--)
diff --git a/drivers/media/platform/xilinx/Kconfig b/drivers/media/platform/xilinx/Kconfig
index 93ef78b..ebc1a56 100644
--- a/drivers/media/platform/xilinx/Kconfig
+++ b/drivers/media/platform/xilinx/Kconfig
@@ -6,6 +6,7 @@ config VIDEO_XILINX
 	tristate "Xilinx Video IP (EXPERIMENTAL)"
 	depends on V4L_PLATFORM_DRIVERS
 	depends on VIDEO_DEV  && OF && HAS_DMA
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	select MEDIA_CONTROLLER
 	select VIDEO_V4L2_SUBDEV_API
 	select VIDEOBUF2_DMA_CONTIG
@@ -15,6 +16,7 @@ config VIDEO_XILINX
 
 config VIDEO_XILINX_CSI2RXSS
 	depends on VIDEO_XILINX
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	tristate "Xilinx CSI-2 Rx Subsystem"
 	help
 	  Driver for Xilinx MIPI CSI-2 Rx Subsystem. This is a V4L sub-device
@@ -24,6 +26,7 @@ config VIDEO_XILINX_CSI2RXSS
 config VIDEO_XILINX_TPG
 	tristate "Xilinx Video Test Pattern Generator"
 	depends on VIDEO_XILINX
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	select VIDEO_XILINX_VTC
 	help
 	   Driver for the Xilinx Video Test Pattern Generator
@@ -31,5 +34,6 @@ config VIDEO_XILINX_TPG
 config VIDEO_XILINX_VTC
 	tristate "Xilinx Video Timing Controller"
 	depends on VIDEO_XILINX
+	depends on !CONFIG_CPU_BIG_ENDIAN
 	help
 	   Driver for the Xilinx Video Timing Controller
diff --git a/drivers/media/radio/wl128x/fmdrv_common.c b/drivers/media/radio/wl128x/fmdrv_common.c
index ad6c451..80592f4 100644
--- a/drivers/media/radio/wl128x/fmdrv_common.c
+++ b/drivers/media/radio/wl128x/fmdrv_common.c
@@ -24,6 +24,8 @@
 #include <linux/module.h>
 #include <linux/jiffies.h>
 
+#include <media/compat.h>
+
 #include "fmdrv.h"
 #include "fmdrv_v4l2.h"
 #include "fmdrv_common.h"
@@ -409,7 +411,7 @@ static int fm_send_cmd(struct fmdev *fmdev, u8 fm_op, u16 type,	void *payload,
 	if (!test_bit(FM_FW_DW_INPROGRESS, &fmdev->flag) ||
 			test_bit(FM_INTTASK_RUNNING, &fmdev->flag)) {
 		/* Fill command header info */
-		hdr = skb_put(skb, FM_CMD_MSG_HDR_SIZE);
+		hdr = (void*)skb_put(skb, FM_CMD_MSG_HDR_SIZE);
 		hdr->hdr = FM_PKT_LOGICAL_CHAN_NUMBER;	/* 0x08 */
 
 		/* 3 (fm_opcode,rd_wr,dlen) + payload len) */
diff --git a/drivers/media/rc/Makefile b/drivers/media/rc/Makefile
index 3d09117..a928526 100644
--- a/drivers/media/rc/Makefile
+++ b/drivers/media/rc/Makefile
@@ -4,7 +4,7 @@ obj-y += keymaps/
 
 rc-core-y := rc-main.o rc-ir-raw.o
 rc-core-$(CONFIG_LIRC) += lirc_dev.o
-rc-core-$(CONFIG_MEDIA_CEC_RC) += rc-cec.o
+rc-core-$(CONFIG_MEDIA_CEC_RC) += keymaps/rc-cec.o
 rc-core-$(CONFIG_BPF_LIRC_MODE2) += bpf-lirc.o
 
 obj-$(CONFIG_RC_CORE) += rc-core.o
diff --git a/drivers/media/rc/ene_ir.c b/drivers/media/rc/ene_ir.c
index 05da41a..7b707e1 100644
--- a/drivers/media/rc/ene_ir.c
+++ b/drivers/media/rc/ene_ir.c
@@ -28,6 +28,8 @@
 #include <media/rc-core.h>
 #include "ene_ir.h"
 
+#include <media/compat.h>
+
 static int sample_period;
 static bool learning_mode_force;
 static int debug;
diff --git a/drivers/media/rc/gpio-ir-recv.c b/drivers/media/rc/gpio-ir-recv.c
index 22e524b..147ec0f 100644
--- a/drivers/media/rc/gpio-ir-recv.c
+++ b/drivers/media/rc/gpio-ir-recv.c
@@ -16,6 +16,8 @@
 #include <linux/irq.h>
 #include <media/rc-core.h>
 
+#include <media/compat.h>
+
 #define GPIO_IR_DEVICE_NAME	"gpio_ir_recv"
 
 struct gpio_rc_dev {
diff --git a/drivers/media/rc/igorplugusb.c b/drivers/media/rc/igorplugusb.c
index b40dbf5..7aa1a7c 100644
--- a/drivers/media/rc/igorplugusb.c
+++ b/drivers/media/rc/igorplugusb.c
@@ -18,6 +18,8 @@
 #include <linux/usb/input.h>
 #include <media/rc-core.h>
 
+#include <media/compat.h>
+
 #define DRIVER_DESC		"IgorPlug-USB IR Receiver"
 #define DRIVER_NAME		"igorplugusb"
 
diff --git a/drivers/media/rc/iguanair.c b/drivers/media/rc/iguanair.c
index c9cb827..ed656e3 100644
--- a/drivers/media/rc/iguanair.c
+++ b/drivers/media/rc/iguanair.c
@@ -14,6 +14,8 @@
 #include <linux/completion.h>
 #include <media/rc-core.h>
 
+#include <media/compat.h>
+
 #define BUF_SIZE 152
 
 struct iguanair {
diff --git a/drivers/media/rc/imon.c b/drivers/media/rc/imon.c
index 8f1f311..ecd718e 100644
--- a/drivers/media/rc/imon.c
+++ b/drivers/media/rc/imon.c
@@ -32,6 +32,10 @@
 
 #include <linux/timer.h>
 
+#include <linux/refcount.h>
+
+#include <media/compat.h>
+
 #define MOD_AUTHOR	"Jarod Wilson <jarod@wilsonet.com>"
 #define MOD_DESC	"Driver for SoundGraph iMON MultiMedia IR/Display"
 #define MOD_NAME	"imon"
diff --git a/drivers/media/rc/ir-mce_kbd-decoder.c b/drivers/media/rc/ir-mce_kbd-decoder.c
index 66e8feb..541a64a 100644
--- a/drivers/media/rc/ir-mce_kbd-decoder.c
+++ b/drivers/media/rc/ir-mce_kbd-decoder.c
@@ -10,6 +10,8 @@
 
 #include "rc-core-priv.h"
 
+#include <media/compat.h>
+
 /*
  * This decoder currently supports:
  * - MCIR-2 29-bit IR signals used for mouse movement and buttons
diff --git a/drivers/media/rc/ir-rc6-decoder.c b/drivers/media/rc/ir-rc6-decoder.c
index 3b2c8ba..d8da62b 100644
--- a/drivers/media/rc/ir-rc6-decoder.c
+++ b/drivers/media/rc/ir-rc6-decoder.c
@@ -7,6 +7,8 @@
 #include "rc-core-priv.h"
 #include <linux/module.h>
 
+#include <media/compat.h>
+
 /*
  * This decoder currently supports:
  * RC6-0-16	(standard toggle bit in header)
diff --git a/drivers/media/rc/ir-sony-decoder.c b/drivers/media/rc/ir-sony-decoder.c
index bb25867..fc8ea92 100644
--- a/drivers/media/rc/ir-sony-decoder.c
+++ b/drivers/media/rc/ir-sony-decoder.c
@@ -8,6 +8,8 @@
 #include <linux/module.h>
 #include "rc-core-priv.h"
 
+#include <media/compat.h>
+
 #define SONY_UNIT		600 /* us */
 #define SONY_HEADER_PULSE	(4 * SONY_UNIT)
 #define	SONY_HEADER_SPACE	(1 * SONY_UNIT)
diff --git a/drivers/media/rc/keymaps/rc-cec.c b/drivers/media/rc/keymaps/rc-cec.c
index 068e22a..4d63655 100644
--- a/drivers/media/rc/keymaps/rc-cec.c
+++ b/drivers/media/rc/keymaps/rc-cec.c
@@ -17,6 +17,8 @@
 #include <media/rc-map.h>
 #include <linux/module.h>
 
+#include <media/compat.h>
+
 /*
  * CEC Spec "High-Definition Multimedia Interface Specification" can be obtained
  * here: http://xtreamerdev.googlecode.com/files/CEC_Specs.pdf
diff --git a/drivers/media/rc/keymaps/rc-ct-90405.c b/drivers/media/rc/keymaps/rc-ct-90405.c
index 8914c83..c55465d 100644
--- a/drivers/media/rc/keymaps/rc-ct-90405.c
+++ b/drivers/media/rc/keymaps/rc-ct-90405.c
@@ -8,6 +8,8 @@
 #include <media/rc-map.h>
 #include <linux/module.h>
 
+#include <media/compat.h>
+
 static struct rc_map_table ct_90405[] = {
 	{ 0x4014, KEY_SWITCHVIDEOMODE },
 	{ 0x4012, KEY_POWER },
diff --git a/drivers/media/rc/keymaps/rc-imon-rsc.c b/drivers/media/rc/keymaps/rc-imon-rsc.c
index 38787dd..4bb83ed 100644
--- a/drivers/media/rc/keymaps/rc-imon-rsc.c
+++ b/drivers/media/rc/keymaps/rc-imon-rsc.c
@@ -5,6 +5,8 @@
 #include <media/rc-map.h>
 #include <linux/module.h>
 
+#include <media/compat.h>
+
 //
 // Note that this remote has a stick which its own IR protocol,
 // with 16 directions. This is supported by the imon_rsc BPF decoder
diff --git a/drivers/media/rc/keymaps/rc-xbox-360.c b/drivers/media/rc/keymaps/rc-xbox-360.c
index 231aa00..86f510a 100644
--- a/drivers/media/rc/keymaps/rc-xbox-360.c
+++ b/drivers/media/rc/keymaps/rc-xbox-360.c
@@ -5,6 +5,8 @@
 #include <media/rc-map.h>
 #include <linux/module.h>
 
+#include <media/compat.h>
+
 /*
  * Manual for remote available at:
  * http://download.microsoft.com/download/b/c/e/bce76f3f-db51-4c98-b79d-b3d21e90ccc1/universalmediaremote_na_0609.pdf
diff --git a/drivers/media/rc/lirc_dev.c b/drivers/media/rc/lirc_dev.c
index 5903f89..c1ea756 100644
--- a/drivers/media/rc/lirc_dev.c
+++ b/drivers/media/rc/lirc_dev.c
@@ -17,6 +17,8 @@
 #include <linux/sched.h>
 #include <linux/wait.h>
 
+#include <media/compat.h>
+
 #include "rc-core-priv.h"
 #include <uapi/linux/lirc.h>
 
@@ -67,7 +69,7 @@ void lirc_raw_event(struct rc_dev *dev, struct ir_raw_event ev)
 
 	/* Normal sample */
 	} else {
-		if (dev->gap_start) {
+		if (dev->gap_start.tv64) {
 			u64 duration = ktime_us_delta(ktime_get(),
 						      dev->gap_start);
 
@@ -78,7 +80,7 @@ void lirc_raw_event(struct rc_dev *dev, struct ir_raw_event ev)
 			list_for_each_entry(fh, &dev->lirc_fh, list)
 				kfifo_put(&fh->rawir, LIRC_SPACE(duration));
 			spin_unlock_irqrestore(&dev->lirc_fh_lock, flags);
-			dev->gap_start = 0;
+			dev->gap_start.tv64 = 0;
 		}
 
 		sample = ev.pulse ? LIRC_PULSE(ev.duration) :
diff --git a/drivers/media/rc/rc-ir-raw.c b/drivers/media/rc/rc-ir-raw.c
index 16e33d7..8a4154d 100644
--- a/drivers/media/rc/rc-ir-raw.c
+++ b/drivers/media/rc/rc-ir-raw.c
@@ -10,6 +10,8 @@
 #include <linux/sched.h>
 #include "rc-core-priv.h"
 
+#include <media/compat.h>
+
 /* Used to keep track of IR raw clients, protected by ir_raw_handler_lock */
 static LIST_HEAD(ir_raw_client_list);
 
diff --git a/drivers/media/rc/rc-main.c b/drivers/media/rc/rc-main.c
index 079885e..7850683 100644
--- a/drivers/media/rc/rc-main.c
+++ b/drivers/media/rc/rc-main.c
@@ -18,6 +18,8 @@
 #include <linux/module.h>
 #include "rc-core-priv.h"
 
+#include <media/compat.h>
+
 /* Sizes are in bytes, 256 bytes allows for 32 entries on x64 */
 #define IR_TAB_MIN_SIZE	256
 #define IR_TAB_MAX_SIZE	8192
diff --git a/drivers/media/rc/serial_ir.c b/drivers/media/rc/serial_ir.c
index d977ce2..53dac58 100644
--- a/drivers/media/rc/serial_ir.c
+++ b/drivers/media/rc/serial_ir.c
@@ -27,6 +27,8 @@
 #include <linux/spinlock.h>
 #include <media/rc-core.h>
 
+#include <media/compat.h>
+
 struct serial_ir_hw {
 	int signal_pin;
 	int signal_pin_change;
diff --git a/drivers/media/spi/Makefile b/drivers/media/spi/Makefile
index 6ac7adc..3b59e8e 100644
--- a/drivers/media/spi/Makefile
+++ b/drivers/media/spi/Makefile
@@ -1,6 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends/cxd2880
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends/cxd2880
 
 # Please keep it alphabetically sorted by Kconfig name
 # (e. g. LC_ALL=C sort Makefile)
diff --git a/drivers/media/test-drivers/vidtv/vidtv_pes.c b/drivers/media/test-drivers/vidtv/vidtv_pes.c
index 4e4d672..6b8f85d 100644
--- a/drivers/media/test-drivers/vidtv/vidtv_pes.c
+++ b/drivers/media/test-drivers/vidtv/vidtv_pes.c
@@ -23,6 +23,8 @@
 #include "vidtv_encoder.h"
 #include "vidtv_ts.h"
 
+#include <media/compat.h>
+
 #define PRIVATE_STREAM_1_ID 0xbd /* private_stream_1. See SMPTE 302M-2007 p.6 */
 #define PES_HEADER_MAX_STUFFING_BYTES 32
 #define PES_TS_HEADER_MAX_STUFFING_BYTES 182
diff --git a/drivers/media/test-drivers/vidtv/vidtv_psi.c b/drivers/media/test-drivers/vidtv/vidtv_psi.c
index bb22285..7cbbb8d 100644
--- a/drivers/media/test-drivers/vidtv/vidtv_psi.c
+++ b/drivers/media/test-drivers/vidtv/vidtv_psi.c
@@ -27,6 +27,8 @@
 #include "vidtv_psi.h"
 #include "vidtv_ts.h"
 
+#include <media/compat.h>
+
 #define CRC_SIZE_IN_BYTES 4
 #define MAX_VERSION_NUM 32
 #define INITIAL_CRC 0xffffffff
diff --git a/drivers/media/test-drivers/vivid/vivid-rds-gen.c b/drivers/media/test-drivers/vivid/vivid-rds-gen.c
index b5b104e..26bcea9 100644
--- a/drivers/media/test-drivers/vivid/vivid-rds-gen.c
+++ b/drivers/media/test-drivers/vivid/vivid-rds-gen.c
@@ -10,6 +10,8 @@
 #include <linux/string.h>
 #include <linux/videodev2.h>
 
+#include <media/compat.h>
+
 #include "vivid-rds-gen.h"
 
 static u8 vivid_get_di(const struct vivid_rds_gen *rds, unsigned grp)
diff --git a/drivers/media/test-drivers/vivid/vivid-vbi-gen.c b/drivers/media/test-drivers/vivid/vivid-vbi-gen.c
index a141369..15f2f03 100644
--- a/drivers/media/test-drivers/vivid/vivid-vbi-gen.c
+++ b/drivers/media/test-drivers/vivid/vivid-vbi-gen.c
@@ -11,6 +11,8 @@
 #include <linux/string.h>
 #include <linux/videodev2.h>
 
+#include <media/compat.h>
+
 #include "vivid-vbi-gen.h"
 
 static void wss_insert(u8 *wss, u32 val, unsigned size)
diff --git a/drivers/media/usb/as102/Makefile b/drivers/media/usb/as102/Makefile
index de671ae..5a3f9f6 100644
--- a/drivers/media/usb/as102/Makefile
+++ b/drivers/media/usb/as102/Makefile
@@ -4,4 +4,4 @@ dvb-as102-objs := as102_drv.o as102_fw.o as10x_cmd.o as10x_cmd_stream.o \
 
 obj-$(CONFIG_DVB_AS102) += dvb-as102.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
diff --git a/drivers/media/usb/au0828/Makefile b/drivers/media/usb/au0828/Makefile
index 4347812..e31a771 100644
--- a/drivers/media/usb/au0828/Makefile
+++ b/drivers/media/usb/au0828/Makefile
@@ -11,7 +11,7 @@ endif
 
 obj-$(CONFIG_VIDEO_AU0828) += au0828.o
 
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
 
 ccflags-y += $(extra-cflags-y) $(extra-cflags-m)
diff --git a/drivers/media/usb/au0828/au0828-dvb.c b/drivers/media/usb/au0828/au0828-dvb.c
index 2a8691a..e5d354c 100644
--- a/drivers/media/usb/au0828/au0828-dvb.c
+++ b/drivers/media/usb/au0828/au0828-dvb.c
@@ -19,6 +19,8 @@
 #include "mxl5007t.h"
 #include "tda18271.h"
 
+#include <media/compat.h>
+
 static int preallocate_big_buffers;
 module_param_named(preallocate_big_buffers, preallocate_big_buffers, int, 0644);
 MODULE_PARM_DESC(preallocate_big_buffers, "Preallocate the larger transfer buffers at module load time");
diff --git a/drivers/media/usb/au0828/au0828-video.c b/drivers/media/usb/au0828/au0828-video.c
index c0f1185..b5c0e9d 100644
--- a/drivers/media/usb/au0828/au0828-video.c
+++ b/drivers/media/usb/au0828/au0828-video.c
@@ -27,6 +27,8 @@
 #include <media/tuner.h>
 #include "au0828-reg.h"
 
+#include <media/compat.h>
+
 static DEFINE_MUTEX(au0828_sysfs_lock);
 
 /* ------------------------------------------------------------------
diff --git a/drivers/media/usb/b2c2/Makefile b/drivers/media/usb/b2c2/Makefile
index 6ae0e43..e9c4dca 100644
--- a/drivers/media/usb/b2c2/Makefile
+++ b/drivers/media/usb/b2c2/Makefile
@@ -2,4 +2,4 @@
 b2c2-flexcop-usb-objs := flexcop-usb.o
 obj-$(CONFIG_DVB_B2C2_FLEXCOP_USB) += b2c2-flexcop-usb.o
 
-ccflags-y += -I $(srctree)/drivers/media/common/b2c2/
+ccflags-y += -I$(srctree)/drivers/media/common/b2c2/
diff --git a/drivers/media/usb/cx231xx/Makefile b/drivers/media/usb/cx231xx/Makefile
index 8acbbcb..66a933a 100644
--- a/drivers/media/usb/cx231xx/Makefile
+++ b/drivers/media/usb/cx231xx/Makefile
@@ -9,5 +9,5 @@ obj-$(CONFIG_VIDEO_CX231XX) += cx231xx.o
 obj-$(CONFIG_VIDEO_CX231XX_ALSA) += cx231xx-alsa.o
 obj-$(CONFIG_VIDEO_CX231XX_DVB) += cx231xx-dvb.o
 
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
diff --git a/drivers/media/usb/em28xx/Makefile b/drivers/media/usb/em28xx/Makefile
index 8c2fc31..07730d1 100644
--- a/drivers/media/usb/em28xx/Makefile
+++ b/drivers/media/usb/em28xx/Makefile
@@ -11,5 +11,5 @@ obj-$(CONFIG_VIDEO_EM28XX_ALSA) += em28xx-alsa.o
 obj-$(CONFIG_VIDEO_EM28XX_DVB) += em28xx-dvb.o
 obj-$(CONFIG_VIDEO_EM28XX_RC) += em28xx-rc.o
 
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
diff --git a/drivers/media/usb/em28xx/em28xx-dvb.c b/drivers/media/usb/em28xx/em28xx-dvb.c
index 9530c41..fed16bc 100644
--- a/drivers/media/usb/em28xx/em28xx-dvb.c
+++ b/drivers/media/usb/em28xx/em28xx-dvb.c
@@ -44,7 +44,7 @@
 #include "mt352.h"
 #include "mt352_priv.h" /* FIXME */
 #include "tda1002x.h"
-#include "drx39xxj.h"
+#include "../../dvb-frontends/drx39xyj/drx39xxj.h"
 #include "tda18271.h"
 #include "s921.h"
 #include "drxd.h"
diff --git a/drivers/media/usb/go7007/Makefile b/drivers/media/usb/go7007/Makefile
index 712a350..b5d6a4a 100644
--- a/drivers/media/usb/go7007/Makefile
+++ b/drivers/media/usb/go7007/Makefile
@@ -9,4 +9,4 @@ go7007-y := go7007-v4l2.o go7007-driver.o go7007-i2c.o go7007-fw.o \
 
 s2250-y := s2250-board.o
 
-ccflags-$(CONFIG_VIDEO_GO7007_LOADER:m=y) += -I $(srctree)/drivers/media/common
+ccflags-$(CONFIG_VIDEO_GO7007_LOADER:m=y) += -I$(srctree)/drivers/media/common
diff --git a/drivers/media/usb/pvrusb2/Makefile b/drivers/media/usb/pvrusb2/Makefile
index 2e71afc..e58c480 100644
--- a/drivers/media/usb/pvrusb2/Makefile
+++ b/drivers/media/usb/pvrusb2/Makefile
@@ -17,5 +17,5 @@ pvrusb2-objs	:= pvrusb2-i2c-core.o \
 
 obj-$(CONFIG_VIDEO_PVRUSB2) += pvrusb2.o
 
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
diff --git a/drivers/media/usb/pvrusb2/pvrusb2-hdw.c b/drivers/media/usb/pvrusb2/pvrusb2-hdw.c
index a966637..29d1046 100644
--- a/drivers/media/usb/pvrusb2/pvrusb2-hdw.c
+++ b/drivers/media/usb/pvrusb2/pvrusb2-hdw.c
@@ -28,6 +28,8 @@
 #include "pvrusb2-cs53l32a.h"
 #include "pvrusb2-audio.h"
 
+#include <media/compat.h>
+
 #define TV_MIN_FREQ     55250000L
 #define TV_MAX_FREQ    850000000L
 
@@ -3664,12 +3666,14 @@ static int pvr2_send_request_ex(struct pvr2_hdw *hdw,
 				  hdw);
 		hdw->ctl_write_urb->actual_length = 0;
 		hdw->ctl_write_pend_flag = !0;
+#if 0 /* reverse 72c27a68a2 */
 		if (usb_urb_ep_type_check(hdw->ctl_write_urb)) {
 			pvr2_trace(
 				PVR2_TRACE_ERROR_LEGS,
 				"Invalid write control endpoint");
 			return -EINVAL;
 		}
+#endif
 		status = usb_submit_urb(hdw->ctl_write_urb,GFP_KERNEL);
 		if (status < 0) {
 			pvr2_trace(PVR2_TRACE_ERROR_LEGS,
@@ -3694,12 +3698,14 @@ status);
 				  hdw);
 		hdw->ctl_read_urb->actual_length = 0;
 		hdw->ctl_read_pend_flag = !0;
+#if 0 /* reverse 72c27a68a2 */
 		if (usb_urb_ep_type_check(hdw->ctl_read_urb)) {
 			pvr2_trace(
 				PVR2_TRACE_ERROR_LEGS,
 				"Invalid read control endpoint");
 			return -EINVAL;
 		}
+#endif
 		status = usb_submit_urb(hdw->ctl_read_urb,GFP_KERNEL);
 		if (status < 0) {
 			pvr2_trace(PVR2_TRACE_ERROR_LEGS,
diff --git a/drivers/media/usb/s2255/s2255drv.c b/drivers/media/usb/s2255/s2255drv.c
index acf18e2..4881d0d 100644
--- a/drivers/media/usb/s2255/s2255drv.c
+++ b/drivers/media/usb/s2255/s2255drv.c
@@ -40,6 +40,8 @@
 #include <media/v4l2-ctrls.h>
 #include <media/v4l2-event.h>
 
+#include <media/compat.h>
+
 #define S2255_VERSION		"1.25.1"
 #define FIRMWARE_FILE_NAME "f2255usb.bin"
 
diff --git a/drivers/media/usb/siano/Makefile b/drivers/media/usb/siano/Makefile
index 758c868..baa2a65 100644
--- a/drivers/media/usb/siano/Makefile
+++ b/drivers/media/usb/siano/Makefile
@@ -1,6 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
 obj-$(CONFIG_SMS_USB_DRV) += smsusb.o
 
-ccflags-y += -I $(srctree)/drivers/media/common/siano
+ccflags-y += -I$(srctree)/drivers/media/common/siano
 ccflags-y += $(extra-cflags-y) $(extra-cflags-m)
 
diff --git a/drivers/media/usb/stk1160/stk1160-v4l.c b/drivers/media/usb/stk1160/stk1160-v4l.c
index a1f785a..ab66be3 100644
--- a/drivers/media/usb/stk1160/stk1160-v4l.c
+++ b/drivers/media/usb/stk1160/stk1160-v4l.c
@@ -25,6 +25,8 @@
 
 #include <media/i2c/saa7115.h>
 
+#include <media/compat.h>
+
 #include "stk1160.h"
 #include "stk1160-reg.h"
 
diff --git a/drivers/media/usb/stk1160/stk1160-video.c b/drivers/media/usb/stk1160/stk1160-video.c
index be074d9..b8d8adb 100644
--- a/drivers/media/usb/stk1160/stk1160-video.c
+++ b/drivers/media/usb/stk1160/stk1160-video.c
@@ -16,6 +16,8 @@
 #include <linux/slab.h>
 #include <linux/ratelimit.h>
 
+#include <media/compat.h>
+
 #include "stk1160.h"
 
 static unsigned int debug;
diff --git a/drivers/media/usb/stk1160/stk1160.h b/drivers/media/usb/stk1160/stk1160.h
index 7b498d1..7af7fc7 100644
--- a/drivers/media/usb/stk1160/stk1160.h
+++ b/drivers/media/usb/stk1160/stk1160.h
@@ -198,5 +198,5 @@ void stk1160_ac97_setup(struct stk1160 *dev);
 
 static inline struct device *stk1160_get_dmadev(struct stk1160 *dev)
 {
-	return bus_to_hcd(dev->udev->bus)->self.sysdev;
+	return bus_to_hcd(dev->udev->bus)->self.controller;
 }
diff --git a/drivers/media/usb/tm6000/Makefile b/drivers/media/usb/tm6000/Makefile
index 75247a0..387e627 100644
--- a/drivers/media/usb/tm6000/Makefile
+++ b/drivers/media/usb/tm6000/Makefile
@@ -10,5 +10,5 @@ obj-$(CONFIG_VIDEO_TM6000) += tm6000.o
 obj-$(CONFIG_VIDEO_TM6000_ALSA) += tm6000-alsa.o
 obj-$(CONFIG_VIDEO_TM6000_DVB) += tm6000-dvb.o
 
-ccflags-y += -I $(srctree)/drivers/media/tuners
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/tuners
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
diff --git a/drivers/media/usb/ttusb-budget/Makefile b/drivers/media/usb/ttusb-budget/Makefile
index 09e42bf..1217eec 100644
--- a/drivers/media/usb/ttusb-budget/Makefile
+++ b/drivers/media/usb/ttusb-budget/Makefile
@@ -1,4 +1,4 @@
 # SPDX-License-Identifier: GPL-2.0-only
 obj-$(CONFIG_DVB_TTUSB_BUDGET) += dvb-ttusb-budget.o
 
-ccflags-y += -I $(srctree)/drivers/media/dvb-frontends
+ccflags-y += -I$(srctree)/drivers/media/dvb-frontends
diff --git a/drivers/media/usb/uvc/uvc_driver.c b/drivers/media/usb/uvc/uvc_driver.c
index 289d6ed..713e6bb 100644
--- a/drivers/media/usb/uvc/uvc_driver.c
+++ b/drivers/media/usb/uvc/uvc_driver.c
@@ -21,6 +21,8 @@
 #include <media/v4l2-common.h>
 #include <media/v4l2-ioctl.h>
 
+#include <media/compat.h>
+
 #include "uvcvideo.h"
 
 #define DRIVER_AUTHOR		"Laurent Pinchart " \
diff --git a/drivers/media/v4l2-core/v4l2-flash-led-class.c b/drivers/media/v4l2-core/v4l2-flash-led-class.c
index e70e128..912a20c 100644
--- a/drivers/media/v4l2-core/v4l2-flash-led-class.c
+++ b/drivers/media/v4l2-core/v4l2-flash-led-class.c
@@ -14,6 +14,8 @@
 #include <linux/types.h>
 #include <media/v4l2-flash-led-class.h>
 
+#include <media/compat.h>
+
 #define has_flash_op(v4l2_flash, op)				\
 	(v4l2_flash && v4l2_flash->ops && v4l2_flash->ops->op)
 
diff --git a/drivers/media/v4l2-core/v4l2-fwnode.c b/drivers/media/v4l2-core/v4l2-fwnode.c
index 8d2e126..43a4cd1 100644
--- a/drivers/media/v4l2-core/v4l2-fwnode.c
+++ b/drivers/media/v4l2-core/v4l2-fwnode.c
@@ -24,6 +24,8 @@
 #include <linux/string.h>
 #include <linux/types.h>
 
+#include <media/compat.h>
+
 #include <media/v4l2-async.h>
 #include <media/v4l2-fwnode.h>
 #include <media/v4l2-subdev.h>
diff --git a/drivers/media/v4l2-core/v4l2-ioctl.c b/drivers/media/v4l2-core/v4l2-ioctl.c
index 12b3361..32615db 100644
--- a/drivers/media/v4l2-core/v4l2-ioctl.c
+++ b/drivers/media/v4l2-core/v4l2-ioctl.c
@@ -31,6 +31,8 @@
 
 #include <trace/events/v4l2.h>
 
+#include <media/compat.h>
+
 /* Zero out the end of the struct pointed to by p.  Everything after, but
  * not including, the specified field is cleared. */
 #define CLEAR_AFTER_FIELD(p, field) \
diff --git a/drivers/media/v4l2-core/videobuf2-dma-sg.c b/drivers/media/v4l2-core/videobuf2-dma-sg.c
index 9985c89..a99983b 100644
--- a/drivers/media/v4l2-core/videobuf2-dma-sg.c
+++ b/drivers/media/v4l2-core/videobuf2-dma-sg.c
@@ -21,6 +21,8 @@
 #include <media/videobuf2-memops.h>
 #include <media/videobuf2-dma-sg.h>
 
+#include <media/compat.h>
+
 static int debug;
 module_param(debug, int, 0644);
 
diff --git a/include/linux/kernel_version.h b/include/linux/kernel_version.h
new file mode 100644
index 0000000..85bd4b9
--- /dev/null
+++ b/include/linux/kernel_version.h
@@ -0,0 +1 @@
+#define V4L2_VERSION 332288
diff --git a/include/linux/refcount.h b/include/linux/refcount.h
new file mode 100644
index 0000000..e828658
--- /dev/null
+++ b/include/linux/refcount.h
@@ -0,0 +1,102 @@
+/* SPDX-License-Identifier: GPL-2.0 */
+#ifndef _LINUX_REFCOUNT_H
+#define _LINUX_REFCOUNT_H
+
+#include <linux/atomic.h>
+#include <linux/mutex.h>
+#include <linux/spinlock.h>
+#include <linux/kernel.h>
+
+/**
+ * refcount_t - variant of atomic_t specialized for reference counts
+ * @refs: atomic_t counter field
+ *
+ * The counter saturates at UINT_MAX and will not move once
+ * there. This avoids wrapping the counter and causing 'spurious'
+ * use-after-free bugs.
+ */
+typedef struct refcount_struct {
+	atomic_t refs;
+} refcount_t;
+
+#define REFCOUNT_INIT(n)	{ .refs = ATOMIC_INIT(n), }
+
+/**
+ * refcount_set - set a refcount's value
+ * @r: the refcount
+ * @n: value to which the refcount will be set
+ */
+static inline void refcount_set(refcount_t *r, unsigned int n)
+{
+	atomic_set(&r->refs, n);
+}
+
+/**
+ * refcount_read - get a refcount's value
+ * @r: the refcount
+ *
+ * Return: the refcount's value
+ */
+static inline unsigned int refcount_read(const refcount_t *r)
+{
+	return atomic_read(&r->refs);
+}
+
+#ifdef CONFIG_REFCOUNT_FULL
+extern __must_check bool refcount_add_not_zero(unsigned int i, refcount_t *r);
+extern void refcount_add(unsigned int i, refcount_t *r);
+
+extern __must_check bool refcount_inc_not_zero(refcount_t *r);
+extern void refcount_inc(refcount_t *r);
+
+extern __must_check bool refcount_sub_and_test(unsigned int i, refcount_t *r);
+
+extern __must_check bool refcount_dec_and_test(refcount_t *r);
+extern void refcount_dec(refcount_t *r);
+#else
+# ifdef CONFIG_ARCH_HAS_REFCOUNT
+#  include <asm/refcount.h>
+# else
+static inline __must_check bool refcount_add_not_zero(unsigned int i, refcount_t *r)
+{
+	return atomic_add_unless(&r->refs, i, 0);
+}
+
+static inline void refcount_add(unsigned int i, refcount_t *r)
+{
+	atomic_add(i, &r->refs);
+}
+
+static inline __must_check bool refcount_inc_not_zero(refcount_t *r)
+{
+	return atomic_add_unless(&r->refs, 1, 0);
+}
+
+static inline void refcount_inc(refcount_t *r)
+{
+	atomic_inc(&r->refs);
+}
+
+static inline __must_check bool refcount_sub_and_test(unsigned int i, refcount_t *r)
+{
+	return atomic_sub_and_test(i, &r->refs);
+}
+
+static inline __must_check bool refcount_dec_and_test(refcount_t *r)
+{
+	return atomic_dec_and_test(&r->refs);
+}
+
+static inline void refcount_dec(refcount_t *r)
+{
+	atomic_dec(&r->refs);
+}
+# endif /* !CONFIG_ARCH_HAS_REFCOUNT */
+#endif /* CONFIG_REFCOUNT_FULL */
+
+extern __must_check bool refcount_dec_if_one(refcount_t *r);
+extern __must_check bool refcount_dec_not_one(refcount_t *r);
+extern __must_check bool refcount_dec_and_mutex_lock(refcount_t *r, struct mutex *lock);
+extern __must_check bool refcount_dec_and_lock(refcount_t *r, spinlock_t *lock);
+
+#endif /* _LINUX_REFCOUNT_H */
diff --git a/include/media/compat.h b/include/media/compat.h
index 51cdae8..7ecec3b 100644
--- a/include/media/compat.h
+++ b/include/media/compat.h
@@ -32,6 +32,11 @@
  */
 #include "config-mycompat.h"
 
+#if LINUX_VERSION_CODE < KERNEL_VERSION(4, 13, 0)
+#include <linux/wait.h>
+typedef struct __wait_queue_head wait_queue_head;
+#endif
+
 #include <linux/compiler.h>
 
 #if LINUX_VERSION_CODE < KERNEL_VERSION(4, 16, 0)
@@ -375,11 +380,11 @@ static inline int fwnode_graph_parse_endpoint(struct fwnode_handle *fwnode,
 static inline void fwnode_handle_get(struct fwnode_handle *fwnode)
 {
 }
-
+#if 0
 static inline void fwnode_handle_put(struct fwnode_handle *fwnode)
 {
 }
-
+#endif
 #endif
 
 #ifdef NEED_FWNODE_GRAPH_GET_ENDPOINT_BY_ID
@@ -1186,6 +1191,7 @@ static inline void dma_unmap_sgtable(struct device *dev, struct sg_table *sgt,
 	dma_unmap_sg_attrs(dev, sgt->sgl, sgt->orig_nents, dir, attrs);
 }
 
+#endif
 static inline void dma_sync_sgtable_for_cpu(struct device *dev,
 		struct sg_table *sgt, enum dma_data_direction dir)
 {
@@ -1198,7 +1204,6 @@ static inline void dma_sync_sgtable_for_device(struct device *dev,
 	dma_sync_sg_for_device(dev, sgt->sgl, sgt->orig_nents, dir);
 }
 #endif
-#endif
 
 #ifdef NEED_IN_COMPAT_SYSCALL
 #include <linux/compat.h>
diff --git a/include/media/config-mycompat.h b/include/media/config-mycompat.h
index 76aaa0b..d56501a 100644
--- a/include/media/config-mycompat.h
+++ b/include/media/config-mycompat.h
@@ -2,3 +2,6 @@
 
 
 #undef NEED_USB_SPEED_WIRELESS
+#undef NEED_PRANDOM_U32_MAX
+#undef NEED_NEXT_PSEUDO_RANDOM32
+#undef NEED_FRAME_VECTOR
diff --git a/include/media/i2c/saa6588.h b/include/media/i2c/saa6588.h
index bbec05a..d1bb04d 100644
--- a/include/media/i2c/saa6588.h
+++ b/include/media/i2c/saa6588.h
@@ -13,6 +13,8 @@
 #ifndef _SAA6588_H
 #define _SAA6588_H
 
+#include <media/compat.h>
+
 struct saa6588_command {
 	unsigned int  block_count;
 	bool          nonblocking;
diff --git a/include/media/media-devnode.h b/include/media/media-devnode.h
index d27c1c6..93ba87d 100644
--- a/include/media/media-devnode.h
+++ b/include/media/media-devnode.h
@@ -21,6 +21,8 @@
 #include <linux/device.h>
 #include <linux/cdev.h>
 
+#include <media/compat.h>
+
 struct media_device;
 
 /*
diff --git a/include/media/media-entity.h b/include/media/media-entity.h
index e383c79..73cff51 100644
--- a/include/media/media-entity.h
+++ b/include/media/media-entity.h
@@ -18,6 +18,8 @@
 #include <linux/list.h>
 #include <linux/media.h>
 
+#include <media/compat.h>
+
 /* Enums used internally at the media controller to represent graphs */
 
 /**
diff --git a/include/media/media-request.h b/include/media/media-request.h
index a18cdbc..32c6bef 100644
--- a/include/media/media-request.h
+++ b/include/media/media-request.h
@@ -18,6 +18,8 @@
 
 #include <media/media-device.h>
 
+#include <media/compat.h>
+
 /**
  * enum media_request_state - media request state
  *
diff --git a/include/media/v4l2-ctrls.h b/include/media/v4l2-ctrls.h
index b3ce438..e178bd5 100644
--- a/include/media/v4l2-ctrls.h
+++ b/include/media/v4l2-ctrls.h
@@ -13,6 +13,8 @@
 #include <linux/videodev2.h>
 #include <media/media-request.h>
 
+#include <media/compat.h>
+
 /*
  * Include the stateless codec compound control definitions.
  * This will move to the public headers once this API is fully stable.
diff --git a/include/media/v4l2-dev.h b/include/media/v4l2-dev.h
index 5cf1ede..bed9e93 100644
--- a/include/media/v4l2-dev.h
+++ b/include/media/v4l2-dev.h
@@ -19,6 +19,8 @@
 
 #include <media/media-entity.h>
 
+#include <media/compat.h>
+
 #define VIDEO_MAJOR	81
 
 /**
@@ -39,7 +41,8 @@ enum vfl_devnode_type {
 	VFL_TYPE_SUBDEV,
 	VFL_TYPE_SDR,
 	VFL_TYPE_TOUCH,
-	VFL_TYPE_MAX /* Shall be the last one */
+	VFL_TYPE_MAX, /* Shall be the last one */
+	VFL_TYPE_GRABBER = VFL_TYPE_VIDEO,
 };
 
 /**
diff --git a/include/media/v4l2-fwnode.h b/include/media/v4l2-fwnode.h
index 15e4ab6..300ef30 100644
--- a/include/media/v4l2-fwnode.h
+++ b/include/media/v4l2-fwnode.h
@@ -21,6 +21,8 @@
 
 #include <media/v4l2-mediabus.h>
 
+#include <media/compat.h>
+
 struct fwnode_handle;
 struct v4l2_async_notifier;
 struct v4l2_async_subdev;
diff --git a/include/media/videobuf-core.h b/include/media/videobuf-core.h
index 2e01b2e..dc0f708 100644
--- a/include/media/videobuf-core.h
+++ b/include/media/videobuf-core.h
@@ -16,6 +16,8 @@
 #include <linux/poll.h>
 #include <linux/videodev2.h>
 
+#include <media/compat.h>
+
 #define UNSET (-1U)
 
 
diff --git a/include/media/videobuf2-core.h b/include/media/videobuf2-core.h
index a12fa6e..723a5d2 100644
--- a/include/media/videobuf2-core.h
+++ b/include/media/videobuf2-core.h
@@ -18,7 +18,8 @@
 #include <linux/dma-buf.h>
 #include <linux/bitops.h>
 #include <media/media-request.h>
-#include <media/frame_vector.h>
+//#include <media/frame_vector.h>
+#include <linux/mm.h>
 
 #define VB2_MAX_FRAME	(32)
 #define VB2_MAX_PLANES	(8)
-- 
2.7.4

